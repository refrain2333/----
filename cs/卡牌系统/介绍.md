# `cs/卡牌系统/` 模块说明

本模块负责**扑克牌核心的数据、视图与控制**，遵循《奥术学院扑克——分阶段实现指南 (v1.6)》提出的 MVC + 信号解耦架构。

> 目前目录仍位于 `cs/卡牌系统/`，后续可按指南迁移到 `cs/主场景/card/`，但脚本职责保持不变。

---

## 1. 子目录结构
| 子目录 | 角色 | 主要脚本 | 说明 |
|--------|------|----------|------|
| `数据/` | Model | `CardData.gd`, `JokerData.gd`, `CardModifier.gd` | 纯数据 `Resource`，无渲染/流程逻辑 |
| `视图/` | View | `CardView.gd`, `JokerCard.gd` | 控制卡片渲染、输入交互与状态高亮 |
| `控制/` | Controller | （阶段三新增）`CardManager.gd` | 管理牌库/手牌/弃牌堆与出牌流程 |
| `对象池/` | 优化 | `CardPool.gd` | 复用 `CardView` 实例，减少创建开销 |

---

## 2. 关键脚本职责
### 2.1 `CardData.gd`（Model）
- 继承 `Resource`，字段：`card_id`, `card_name`, `card_suit`, `base_value` 等。
- 强化字段：`wax_seal_types:Array[String]`, `frame_type:String`, `material_type:String`。
- 方法：`clone()`, `add_reinforcement()`, `get_modified_value(game_manager)` 等。

### 2.2 `CardView.gd`（View）
- 继承 `Control`，加载 `CardData` 并更新纹理/文字。
- 交互：鼠标悬停放大、拖拽高亮、点击选中。
- 强化显示：根据 `CardData` 的蜡封/牌框/材质，切换子节点图标或播放动画。
- 信号：`card_clicked(card_view)`, `card_hovered(card_view)`。

### 2.3 `CardManager.gd`（Controller / 阶段三新增）
- 字段：`deck`, `hand`, `discard_pile`, `destroyed_pile`。
- 方法：`draw(count)`, `discard(index)`, `play_card(index)`, `add_card_to_deck(card_data)` 等。
- 信号：`hand_changed`, `deck_changed`, `cards_played`。

---

## 3. 与全局系统的交互
- **GameManager**：调用 `ScoreCalculator` 计算得分后通知 `GameManager.add_player_score()`；监听 `GameManager.current_hand_size` 限制抽牌数。
- **EventManager**：触发或响应特殊 Buff（如"魔力灌注"抽牌+1）。
- **UI 层**：`HandDock` 接收 `hand_changed` 信号动态生成 `CardView`。

---

## 4. 设计要点（来自 v1.6 指南）
1. **高内聚**：Model / View / Controller 分离，便于单元测试与功能替换。
2. **低耦合**：模块间仅通过信号或接口方法交互，无直接访问对方内部字段。
3. **对象池**：`CardPool` 在场景初始化时预创建若干 `CardView`，重复利用以提升性能。
4. **数据驱动**：所有强化逻辑读取 `CardData` 字段，不在 View 中硬编码。
5. **可扩展**：新增卡牌类型或材质，仅需新增图标资源与数据字段，不改动核心逻辑。

---

## 5. 后续迁移与重构计划
- **目录统一**：待阶段三完成后，将本模块移动至 `cs/主场景/card/`，与指南保持一致，并更新资源路径。
- **CardManager 集成**：在阶段三实现牌库逻辑并替换 `GameManager` 内旧的抽牌/弃牌片段。
- **单元测试**：使用 GUT 编写 `test/card_manager_test.gd`, `test/card_view_test.gd` 验证核心逻辑。

---

## 6. 当前耦合问题分析与迁移方案

### 6.1 当前存在的问题
目前卡牌系统与主场景存在以下耦合问题：

1. **代码重复**：`CardManager.gd` 在卡牌系统和主场景/card目录下都有实现，造成功能重叠和维护困难
2. **全局依赖混乱**：
   - `CardView.gd` 中直接使用 `GlobalEnums` 但未正确导入
   - 枚举值使用方式不一致，有的使用字符串，有的使用枚举值
3. **引用路径不统一**：部分脚本使用相对路径，部分使用绝对路径
4. **视图与逻辑耦合**：`CardView.gd` 包含部分业务逻辑，而不是纯视图逻辑

### 6.2 详细迁移步骤

1. **合并 CardManager**
   - 保留 `cs/主场景/card/CardManager.gd` 作为最终版本
   - 确保其包含 `cs/卡牌系统/控制/CardManager.gd` 的所有功能
   - 统一信号命名和参数

2. **修复全局依赖**
   - 所有脚本统一添加 `const GlobalEnums = preload("res://cs/Global/GlobalEnums.gd")`
   - 替换所有字符串枚举为正确的枚举引用，如 `"RED"` → `str(GlobalEnums.WaxSealType.RED)`
   - 确保 `CardView.gd` 中的枚举引用正确

3. **分离视图与逻辑**
   - 将 `CardView.gd` 中的业务逻辑移至 `CardManager.gd`
   - `CardView.gd` 只保留渲染、动画和基础交互逻辑

4. **统一资源路径**
   - 使用相对路径 `res://` 开头的资源引用
   - 卡牌资源路径统一为 `res://assets/data/cards/`

5. **迁移顺序**
   - 先迁移 Model 层 (`CardData.gd` 等)
   - 再迁移 View 层 (`CardView.gd` 等)
   - 最后迁移 Controller 层 (`CardManager.gd`)

### 6.3 迁移后的目录结构

完成迁移后，`cs/主场景/card/` 目录将包含：

```
cs/主场景/card/
  ├── data/              # 数据层
  │   ├── CardData.gd    # 卡牌数据类
  │   └── ...
  ├── view/              # 视图层
  │   ├── CardView.gd    # 卡牌视图类
  │   ├── Card.tscn      # 卡牌场景
  │   └── ...
  ├── pool/              # 对象池
  │   └── CardPool.gd    # 卡牌对象池
  └── CardManager.gd     # 卡牌管理器
```

而 `cs/卡牌系统/` 将仅保留此介绍文档，作为历史记录和设计参考。

---

本文件将随阶段推进持续更新，确保开发者始终了解 **卡牌系统** 的职责边界与最新实现状态。
