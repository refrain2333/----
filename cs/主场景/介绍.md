# `cs/主场景/` 模块说明

`cs/主场景/` 承载 **主循环场景逻辑 + UI 交互集线器**，是所有子模块汇聚与信号路由的中心。设计遵循《奥术学院扑克——分阶段实现指南 (v1.6)》的 **垂直切片** 与 **单例职责** 原则。

---

## 1. 顶层脚本&场景
| 文件 | 角色 | 说明 |
|------|------|------|
| `MainGame.tscn` | 主场景 | 根节点通常为 `Node` 或 `Control`，包含 HUD、手牌区域等子场景。
| `MainGame.gd` | 控制器 | 监听 `GameManager`, `CardManager`, `EventManager` 等信号；中转 UI 请求；驱动场景切换。

---

## 2. 子目录概览
| 子目录 | 主要内容 | 责任 |
|--------|----------|------|
| `abilities/` | `ArtifactData.gd`, `SpellData.gd`, `JokerData.gd` | 能力数据脚本，阶段一已完成资源化 |
| `card/` | （待迁移自 `cs/卡牌系统`） | 卡牌 Model / View / Controller |
| `discovery/` | 探索/解锁逻辑 | 暂留，后续可用作图鉴或成就 |
| `joker/` | 守护灵相关 UI/脚本 | 例如 `JokerPanel.gd` |
| `manager/` | 单例/流程管理 | `GameManager.gd`, `EventManager.gd`, `WisdomHallManager.gd` 等 |
| `model/` | 游戏通用数据模型 | 例如 `GameState.gd`（若存在） |
| `ui/` | UI 组件场景与脚本 | HUD、Sidebar、HandDock、弹窗、商店面板等 |

> **提示**：部分目录空白或占位，后续阶段按指南逐渐填充。

---

## 3. 信号流向示意
```
             +----------------+
             |  UI 控件脚本   |
             +-------+--------+
                     |
                     | 用户输入 (点击/拖拽)
                     v
+----------------+   emit_signal    +----------------+
| MainGame.gd    +----------------->| GameManager    |
+--+-------------+                  +--+-------------+
   |监听hand_changed                     | 发出 game_state_changed
   |                                      v
   |    +----------------+           +----------------+
   +----+ CardManager    |<----------+ ScoreCalculator|
        +----------------+  使用     +----------------+
```
- **MainGame.gd** 接收 UI 信号，如 `play_cards_requested`，转发给 `CardManager`。
- **GameManager** 更新分数/资源后，发 `game_state_changed`，UI 通过 `MainGame.gd` 更新显示。
- **EventManager** 插入 Buff/Debuff 信号，由 `MainGame.gd` 统一捕获并弹窗提示。

---

## 4. 阶段任务映射
| 阶段 | 与主场景相关任务 |
|------|------------------|
| 二 | HUD 场景、WisdomHall/Assessment 面板、信号连接 |
| 三 | 手牌区域 `HandDock`、DeckBrowser UI、CardManager 集成 |
| 四 | 侧边栏 `Sidebar`、流程整合测试、TermReward 弹窗 |
| 五 | EventPopup、流程打通、体验调优 |
| 六 | 动效、音效、国际化、多分辨率适配 |

---

## 5. 设计要点
1. **信号集中转**：`MainGame.gd` 扮演"总线"角色，避免 UI 直接依赖深层逻辑。  
2. **场景分层**：UI 子场景可单独运行，便于设计师调试。  
3. **可插拔**：各面板 (`WisdomHallUI`, `AssessmentUI` 等) 独立脚本与场景，按需 `visible`/`add_child` 切换。  
4. **解耦测试**：编写最小测试场景，只加载 `MainGame.tscn` 即可回归测试整条流程。

---

## 6. 当前耦合问题与解决方案
### 6.1 问题分析
当前 `cs/卡牌系统/` 与 `cs/主场景/` 存在逻辑混乱和耦合问题：
1. **重复代码**：`CardManager.gd` 同时存在于两个目录，功能有重叠
2. **依赖混乱**：`MainGame.gd` 直接引用 `卡牌系统` 中的视图组件
3. **职责不清**：卡牌数据处理和游戏流程逻辑边界模糊
4. **全局依赖**：两者都依赖 `GlobalEnums`，但引用方式不统一

### 6.2 解决方案
按照分阶段实现指南，应进行以下重构：
1. **完成迁移**：将 `cs/卡牌系统/` 中的关键组件迁移至 `cs/主场景/card/`
2. **清晰分层**：
   - `CardData.gd` → 纯数据层，无游戏流程逻辑
   - `CardView.gd` → 纯视图层，处理渲染和输入
   - `CardManager.gd` → 控制层，管理卡牌生命周期
3. **统一引用**：所有对 `GlobalEnums` 的引用使用 `const GlobalEnums = preload("...")`
4. **信号解耦**：`CardManager` 发出信号，`MainGame` 监听并转发给 UI

### 6.3 执行步骤
1. 合并 `CardManager.gd` 的两个版本，保留 `cs/主场景/card/` 中的版本
2. 更新 `MainGame.gd` 中对卡牌系统的引用路径
3. 移除 `cs/卡牌系统/` 中已迁移的脚本，保留说明文档
4. 统一全局枚举的引用方式和常量定义

此文档将随阶段推进补充具体文件与职责变更，保持团队成员对 **主场景模块** 的共同认知。
