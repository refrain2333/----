# 出牌系统测试 (重构版)

## 📋 功能概述

这是一个**完全重构**的出牌系统测试场景，采用**组件化架构**，代码量从1000+行减少到600行，同时保持功能完整性。集成了完整的牌库管理、回合制操作限制、得分系统和智能卡牌替换机制。

## 🚀 重构亮点

- **📦 组件化架构**: 所有复杂逻辑封装在可复用的管理器组件中
- **🔧 代码简化**: 代码量减少40%，可维护性大幅提升
- **⚡ 功能完整**: 保留所有原有功能，新增智能卡牌替换系统
- **🎯 配置驱动**: 游戏规则通过配置文件管理，易于调整
- **🔗 信号优化**: 完整的信号系统确保组件间正确通信

## ✨ 核心功能

### 🎯 完整牌库系统
- **动态牌库**: 从完整的55张扑克牌库中抽取卡牌（包含小丑牌）
- **智能补牌**: 出牌后自动从牌库补充手牌，保持手牌数量
- **牌库状态**: 实时显示牌库剩余数量和手牌数量
- **洗牌机制**: 支持牌库洗牌和重组
- **牌库查看**: 点击右下角图标可查看完整牌库

### 🎮 回合制操作系统
- **出牌限制**: 每回合最多3次出牌操作（可配置）
- **弃牌限制**: 每回合最多2次弃牌操作（可配置）
- **智能按钮**: 根据选择状态和次数限制自动更新按钮状态
- **次数显示**: 实时显示剩余操作次数和按钮文本
- **外部验证**: 支持自定义出牌验证逻辑

### 🏆 完整得分系统
- **智能计分**: 基于卡牌数值和组合的得分计算
- **组合加成**: 多张卡牌组合时获得额外得分
- **回合得分**: 显示当前回合累计得分
- **总分统计**: 显示游戏总累计得分
- **得分反馈**: 每次出牌后显示详细得分变化

### 🔄 智能卡牌替换
- **位置保持**: 出牌后保持剩余卡牌的相对位置
- **平滑补牌**: 新卡牌自动填充到合适位置
- **位置诊断**: 内置位置系统诊断，确保UI正确性
- **批量操作**: 支持批量卡牌移除和补充

### 📊 测试内容
1. **基础交互测试**
   - 卡牌点击选择/取消选择
   - 选择状态的视觉反馈（高亮、位置提升）
   - 最大选择数量限制（5张）

2. **出牌流程测试**
   - 出牌按钮状态管理
   - 集中力消耗验证
   - 得分计算和显示
   - 手牌更新和重排

3. **回合系统测试**
   - 抽牌阶段执行
   - 出牌阶段管理
   - 计分阶段处理
   - 回合结束清理

4. **边界情况测试**
   - 空手牌处理
   - 资源不足情况
   - 重复选择处理
   - 异常状态恢复

## 🏗️ 重构后技术架构

### 🔧 组件化管理器系统
- **GameSessionConfig**: 游戏会话配置管理（出牌次数、手牌大小等）
- **TurnActionManager**: 回合操作次数管理和限制
- **GameScoreManager**: 得分计算和统计管理
- **DeckViewIntegrationManager**: 牌库查看集成管理
- **SimpleGameManager**: 简化的资源管理器（集中力、精华）

### 🎮 核心游戏组件
- **PlayTurnManager**: 回合流程控制和状态管理
- **CardManager**: 卡牌数据管理和操作
- **HandDock**: 手牌UI显示和交互
- **CardView**: 单张卡牌的视图和交互

### 🔗 完整信号系统
```
PlayTurnManager (主要回合管理)
├── turn_started(phase)
├── turn_ended
├── phase_changed(old_phase, new_phase)
├── cards_selected(selected_cards)
├── cards_played(played_cards, score)
├── play_button_state_changed(enabled, reason)
└── concentration_changed(current, required)

HandDock (手牌交互)
├── card_selection_changed(selected_cards)
├── discard_button_pressed(selected_cards)
├── card_selected_for_play(card_data)
└── card_deselected_for_play(card_data)

TurnActionManager (操作管理)
├── action_performed(action_type, remaining, total)
└── action_limit_reached(action_type)

GameScoreManager (得分管理)
├── score_changed(turn_score, total_score, source)
└── score_reset(reason)

CardView (卡牌视图)
├── card_clicked(card_view)
├── selection_changed(card_view, is_selected)
└── card_hovered(card_view)
```

## 🎮 使用方法

### 运行测试
1. 打开场景 `cs/tests/卡牌相关/出牌系统测试/SimplePlayTestScene.tscn`
2. 运行场景开始测试
3. 系统会自动初始化55张牌库并发放5张初始手牌
4. TurnManager自动进入出牌阶段，可以立即开始游戏

### 🎮 交互操作
- **鼠标操作**:
  - 点击卡牌进行选择/取消选择（支持多选，最多5张）
  - 点击"✧ 吟唱咒语 ✧"按钮出牌（消耗出牌次数，获得得分）
  - 点击"✧ 使用精华 ✧"按钮弃牌（消耗弃牌次数，无得分）
  - 点击"开始回合"重置操作次数
  - 点击"下回合"结算得分并进入新回合
  - 点击右下角牌库图标查看完整牌库

- **⌨️ 键盘快捷键**:
  - `R` - 开始回合（重置操作次数）
  - `N` - 下回合（结算得分并进入新回合）
  - `1` - 出牌（吟唱咒语）
  - `2` - 弃牌（使用精华）

### 🔄 完整测试流程
1. **自动初始化**:
   - 场景自动从55张牌库抽取5张初始手牌
   - TurnManager自动进入出牌阶段
   - SimpleGameManager提供资源管理（集中力10点，精华10点）

2. **卡牌选择测试**:
   - 点击卡牌进行选择，观察高亮和位置提升效果
   - 测试多选功能（最多5张）
   - 测试取消选择功能

3. **出牌系统测试**:
   - 选择卡牌后点击"✧ 吟唱咒语 ✧"或按`1`键
   - 观察得分计算（基础分+组合加成）
   - 观察智能卡牌替换（自动补牌到正确位置）
   - 检查操作次数减少（剩余2/3次）

4. **弃牌系统测试**:
   - 选择卡牌后点击"✧ 使用精华 ✧"或按`2`键
   - 观察弃牌操作（无得分）
   - 检查操作次数减少（剩余1/2次）

5. **按钮状态测试**:
   - 观察按钮根据选择状态实时变化
   - 测试操作次数用完后按钮禁用
   - 测试按钮文本动态更新

6. **回合管理测试**:
   - 按`R`重置操作次数
   - 按`N`结算得分并进入下回合

## 🧪 完整测试用例

### ✅ 基础功能测试（已验证）
- **卡牌选择功能**:
  - 选择单张卡牌 ✓
  - 选择多张卡牌 ✓
  - 取消选择 ✓
  - 达到选择上限（5张）✓
  - 视觉反馈（高亮、位置提升）✓

- **出牌功能**:
  - 正常出牌 ✓
  - 得分计算（基础分+组合加成）✓
  - 智能卡牌替换 ✓
  - 操作次数限制 ✓
  - 外部验证器 ✓

- **弃牌功能**:
  - 正常弃牌 ✓
  - 操作次数限制 ✓
  - 无得分处理 ✓

### ✅ 集成测试（已验证）
- **回合流程**:
  - 抽牌阶段 ✓
  - 出牌阶段 ✓
  - 计分阶段 ✓
  - 阶段切换 ✓

- **UI同步**:
  - 按钮状态实时同步 ✓
  - 选择状态同步 ✓
  - 信息显示更新 ✓
  - 操作次数显示 ✓

- **组件通信**:
  - 信号系统完整连接 ✓
  - 管理器间正确通信 ✓
  - 资源管理同步 ✓

## 📊 当前测试配置

### 🃏 完整牌库系统
- **牌库大小**: 55张卡牌（52张标准牌 + 3张小丑牌）
- **初始手牌**: 5张卡牌
- **手牌范围**: 5-8张（可配置）
- **最大选择**: 5张卡牌

### ⚙️ 游戏规则配置
- **出牌限制**: 每回合最多3次
- **弃牌限制**: 每回合最多2次
- **得分倍率**: 1.0倍（可配置）
- **集中力**: 10点（SimpleGameManager提供）
- **精华**: 10点（SimpleGameManager提供）

### 🎯 得分系统
- **基础得分**: 卡牌base_value之和
- **组合加成**: 多张卡牌组合时额外得分
- **计算公式**: 基础分 + 组合加成分

## 🔧 配置管理

### 📝 GameSessionConfig配置
通过`GameSessionConfig`类管理所有游戏规则:
- `max_play_actions_per_turn`: 每回合最大出牌次数
- `max_discard_actions_per_turn`: 每回合最大弃牌次数
- `initial_hand_size`: 初始手牌数量
- `max_hand_size`: 最大手牌数量
- `score_multiplier`: 得分倍率

### 🎮 TurnManager参数
- `max_selection_count`: 最大选择卡牌数量
- `base_concentration_cost`: 基础集中力消耗
- `min_cards_to_play`: 最少出牌数量

## 🐛 调试功能

### 日志输出
测试场景提供详细的调试日志:
- 组件初始化状态
- 信号连接确认
- 用户交互事件
- 状态变化追踪
- 错误和警告信息

### 实时信息显示
- 当前回合数和阶段
- 选择卡牌数量
- 集中力状态
- 得分变化
- 按钮状态

## 📈 性能考虑

### 优化策略
- 使用对象池管理CardView实例
- 批量更新UI状态
- 延迟加载非关键组件
- 智能信号连接管理

### 内存管理
- 自动清理临时对象
- 正确断开信号连接
- 避免循环引用
- 及时释放资源

## 🔮 扩展功能

### 可能的改进
1. **高级测试**: 添加压力测试和边界测试
2. **自动化测试**: 实现自动化测试脚本
3. **性能分析**: 集成性能监控工具
4. **错误注入**: 添加错误场景测试
5. **回放功能**: 记录和回放测试序列

这个测试场景为出牌系统提供了全面的验证环境，确保所有组件能够正确协作，为玩家提供流畅的游戏体验。
