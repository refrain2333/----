# ğŸ¯ å¥¥æœ¯å­¦é™¢æ‰‘å…‹ - V2.3ç‰Œå‹è¯†åˆ«ä¸è®¡ç®—ç³»ç»ŸæŠ€æœ¯æ–‡æ¡£

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

å¥¥æœ¯å­¦é™¢æ‰‘å…‹çš„V2.3ç‰Œå‹è¯†åˆ«ä¸è®¡ç®—ç³»ç»Ÿæ˜¯ä¸€ä¸ªå®Œæ•´çš„æ‰‘å…‹ç‰Œå‹åˆ†æå’Œå¾—åˆ†è®¡ç®—æ¡†æ¶ï¼Œé‡‡ç”¨**æ¨¡å—åŒ–æ¶æ„**å’Œ**æ•°æ®é©±åŠ¨è®¾è®¡**ï¼Œå®ç°äº†é«˜ç²¾åº¦çš„ç‰Œå‹è¯†åˆ«ã€åŠ¨æ€ç­‰çº§ç³»ç»Ÿå’Œå¤æ‚çš„å¾—åˆ†è®¡ç®—é€»è¾‘ã€‚

### ğŸ—ï¸ æ ¸å¿ƒæ¶æ„

```
HandTypeSystemV2 (ç»Ÿä¸€æ¥å£å±‚)
â”œâ”€â”€ SmartHandAnalyzerV2 (æ™ºèƒ½ç‰Œå‹åˆ†æ)
â”‚   â””â”€â”€ PokerHandAnalyzer (5å¼ ç‰Œåˆ†æå™¨)
â”œâ”€â”€ PreciseScoreCalculator (V2.3å¾—åˆ†è®¡ç®—)
â”œâ”€â”€ HandTypeRankingManager (åŠ¨æ€ç­‰çº§ç®¡ç†)
â””â”€â”€ HandTypeEnums (é…ç½®æ•°æ®ä¸­å¿ƒ)
```

### ğŸ® V2.3æ ¸å¿ƒç‰¹æ€§

- **å¢å¼ºçš„åŸºç¡€åˆ†æ•°ç³»ç»Ÿ**: å¹³è¡¡çš„10-3000åˆ†å€¼èŒƒå›´
- **åŠ¨æ€ç­‰çº§ç³»ç»Ÿ**: LV1-LV5è¿›åº¦ï¼Œæ¯ä¸ªç‰Œå‹ç‹¬ç«‹æˆé•¿
- **ä¸¤é˜¶æ®µè®¡åˆ†æ¨¡å‹**: æ ¸å¿ƒåˆ†æ•° + æœ€ç»ˆå€ç‡çš„å¤æ‚è®¡ç®—
- **æ™ºèƒ½ç‰Œå‹è¯†åˆ«**: æ”¯æŒ1-Nå¼ ç‰Œçš„æœ€ä½³ç»„åˆåˆ†æ
- **é«˜ç²¾åº¦è®¡ç®—**: æ”¯æŒå°æ•°è®¡ç®—ï¼Œæœ€ç»ˆèˆå…¥ç¡®ä¿ç²¾åº¦

---

## ğŸ¯ æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. HandTypeSystemV2 - ç»Ÿä¸€æ¥å£å±‚

**èŒè´£**: æä¾›ç»Ÿä¸€çš„ç‰Œå‹è¯†åˆ«å’Œå¾—åˆ†è®¡ç®—æ¥å£

**æ ¸å¿ƒæ–¹æ³•**:
```gdscript
# å®Œæ•´åˆ†ææ¥å£ï¼ˆç‰Œå‹è¯†åˆ« + å¾—åˆ†è®¡ç®—ï¼‰
static func analyze_and_score(cards: Array, ranking_manager = null, bonus_score: int = 0, final_multiplier: float = 1.0) -> Dictionary

# ä»…ç‰Œå‹è¯†åˆ«æ¥å£
static func analyze_hand_type(cards: Array) -> HandResult

# ä»…å¾—åˆ†è®¡ç®—æ¥å£
static func calculate_score(hand_result: HandResult, ranking_manager = null, bonus_score: int = 0, final_multiplier: float = 1.0) -> ScoreResult

# å¿«é€Ÿå¾—åˆ†æ¥å£
static func quick_score(cards: Array, level: int = 1, bonus_score: int = 0, final_multiplier: float = 1.0) -> int
```

**è¿”å›ç»“æœç»“æ„**:
```gdscript
{
    "hand_result": HandResult,      # ç‰Œå‹è¯†åˆ«ç»“æœ
    "score_result": ScoreResult,    # å¾—åˆ†è®¡ç®—ç»“æœ
    "total_analysis_time": int,     # æ€»åˆ†æè€—æ—¶(ms)
    "is_valid": bool               # ç»“æœæœ‰æ•ˆæ€§
}
```

### 2. SmartHandAnalyzerV2 - æ™ºèƒ½ç‰Œå‹åˆ†æå™¨

**èŒè´£**: æ™ºèƒ½åˆ†æ1-Nå¼ ç‰Œçš„æœ€ä½³ç‰Œå‹

**æ ¸å¿ƒç®—æ³•**:
```gdscript
static func find_best_hand(cards: Array) -> HandResult:
    if cards.size() < 5:
        # å°‘äº5å¼ ç‰Œï¼šåˆ†æéƒ¨åˆ†æ‰‹ç‰Œ
        return _analyze_partial_hand(cards)
    elif cards.size() == 5:
        # æ­£å¥½5å¼ ç‰Œï¼šç›´æ¥åˆ†æ
        return PokerHandAnalyzer.analyze(cards)
    else:
        # è¶…è¿‡5å¼ ç‰Œï¼šæ‰¾æœ€ä½³ç»„åˆ
        return _find_best_combination(cards)
```

**åˆ†æç­–ç•¥**:
- **1-4å¼ ç‰Œ**: ç›´æ¥åˆ†æï¼Œå¤æ‚åº¦O(1)
- **5å¼ ç‰Œ**: æ ‡å‡†åˆ†æï¼Œå¤æ‚åº¦O(1)
- **6-10å¼ ç‰Œ**: ç©·ä¸¾ç»„åˆï¼Œå¤æ‚åº¦O(C(n,5))
- **11+å¼ ç‰Œ**: å¯å‘å¼ç®—æ³•ï¼Œå¤æ‚åº¦O(k)

### 3. PokerHandAnalyzer - 5å¼ ç‰Œåˆ†æå™¨

**èŒè´£**: ä¸“é—¨å¤„ç†æ ‡å‡†5å¼ ç‰Œçš„ç‰Œå‹è¯†åˆ«

**æ ¸å¿ƒæµç¨‹**:
```gdscript
static func analyze(cards: Array) -> HandResult:
    # 1. é¢„å¤„ç†å¡ç‰Œæ•°æ®
    var card_data = _preprocess_cards(cards)
    
    # 2. æŒ‰ä¼˜å…ˆçº§å°è¯•å„ç§ç‰Œå‹è¯„ä¼°å™¨
    for evaluator_info in evaluators:
        var result = evaluator_info.evaluator.call(card_data)
        if result != null:
            return result
    
    # 3. è¿”å›ç©ºç»“æœï¼ˆæ— åŒ¹é…ç‰Œå‹ï¼‰
    return HandResult.create_empty()
```

**æ³¨å†Œçš„ç‰Œå‹è¯„ä¼°å™¨**ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰:
1. çš‡å®¶åŒèŠ±é¡ºè¯„ä¼°å™¨
2. åŒèŠ±é¡ºè¯„ä¼°å™¨  
3. å››æ¡è¯„ä¼°å™¨
4. è‘«èŠ¦è¯„ä¼°å™¨
5. åŒèŠ±è¯„ä¼°å™¨
6. é¡ºå­è¯„ä¼°å™¨
7. ä¸‰æ¡è¯„ä¼°å™¨
8. ä¸¤å¯¹è¯„ä¼°å™¨
9. ä¸€å¯¹è¯„ä¼°å™¨
10. é«˜ç‰Œè¯„ä¼°å™¨

---

## ğŸ² ç‰Œå‹è¯†åˆ«è¯¦è§£

### æ”¯æŒçš„ç‰Œå‹

| ç‰Œå‹ | è‹±æ–‡å | åŸºç¡€åˆ† | LV1å€ç‡ | LV5å€ç‡ | æè¿° |
|------|--------|--------|---------|---------|------|
| é«˜ç‰Œ | HIGH_CARD | 10 | 1.0x | 1.6x | æ²¡æœ‰ä»»ä½•ç»„åˆçš„å•å¼ é«˜ç‰Œ |
| ä¸€å¯¹ | PAIR | 25 | 1.2x | 2.0x | ä¸¤å¼ ç›¸åŒæ•°å€¼çš„ç‰Œ |
| ä¸¤å¯¹ | TWO_PAIR | 50 | 1.4x | 2.4x | ä¸¤ä¸ªä¸åŒçš„å¯¹å­ |
| ä¸‰æ¡ | THREE_KIND | 80 | 1.6x | 3.0x | ä¸‰å¼ ç›¸åŒæ•°å€¼çš„ç‰Œ |
| é¡ºå­ | STRAIGHT | 120 | 1.8x | 3.4x | äº”å¼ è¿ç»­æ•°å€¼çš„ç‰Œ |
| åŒèŠ± | FLUSH | 150 | 2.0x | 4.0x | äº”å¼ ç›¸åŒèŠ±è‰²çš„ç‰Œ |
| è‘«èŠ¦ | FULL_HOUSE | 250 | 2.5x | 4.9x | ä¸‰æ¡+ä¸€å¯¹çš„ç»„åˆ |
| å››æ¡ | FOUR_KIND | 500 | 3.0x | 6.2x | å››å¼ ç›¸åŒæ•°å€¼çš„ç‰Œ |
| åŒèŠ±é¡º | STRAIGHT_FLUSH | 1000 | 4.0x | 8.0x | åŒèŠ±+é¡ºå­çš„ç»„åˆ |
| çš‡å®¶åŒèŠ±é¡º | ROYAL_FLUSH | 2000 | 5.0x | 11.0x | 10-J-Q-K-Açš„åŒèŠ±é¡º |
| äº”æ¡ | FIVE_KIND | 3000 | 6.0x | 14.0x | äº”å¼ ç›¸åŒæ•°å€¼çš„ç‰Œï¼ˆç‰¹æ®Šï¼‰ |

### ç‰¹æ®Šè¯†åˆ«é€»è¾‘

#### Açš„åŒé‡å¤„ç†
```gdscript
# Aåœ¨é¡ºå­ä¸­çš„ç‰¹æ®Šå¤„ç†
# ä½ä½é¡ºå­: A-2-3-4-5 (A=1)
# é«˜ä½é¡ºå­: 10-J-Q-K-A (A=14)
# çš‡å®¶åŒèŠ±é¡º: 10-J-Q-K-A åŒèŠ± (A=14)
```

#### ç‰Œé¢å€¼vsåŸºç¡€å€¼åˆ†ç¦»
```gdscript
# face_value: ç”¨äºç‰Œå‹è¯†åˆ«é€»è¾‘ (A=1, K=13, Q=12, J=11)
# base_value: ç”¨äºå¾—åˆ†è®¡ç®— (A=14, K=13, Q=12, J=11)
```

---

## ğŸ’° V2.3å¾—åˆ†è®¡ç®—ç³»ç»Ÿ

### æ ¸å¿ƒè®¡åˆ†å…¬å¼

```
æ ¸å¿ƒåˆ†æ•° = (åŸºç¡€åˆ† + ç‰Œé¢åˆ†) Ã— ç‰Œå‹å€ç‡
æœ€ç»ˆå¾—åˆ† = ROUND((æ ¸å¿ƒåˆ†æ•° + é™„åŠ åˆ†) Ã— æœ€ç»ˆå€ç‡)
```

### ç‰Œé¢ä»·å€¼åˆ†è®¡ç®—

| ç‰Œå‹ | è®¡ç®—å…¬å¼ | ç¤ºä¾‹ |
|------|----------|------|
| é«˜ç‰Œ | æœ€é«˜ç‰Œå€¼ Ã— 1 | Ké«˜ç‰Œ = 13 Ã— 1 = 13 |
| ä¸€å¯¹ | å¯¹å­å€¼ Ã— 2 | ä¸€å¯¹A = 14 Ã— 2 = 28 |
| ä¸¤å¯¹ | å¤§å¯¹Ã—2.5 + å°å¯¹Ã—1.5 | Aå’ŒK = 14Ã—2.5 + 13Ã—1.5 = 54.5 |
| ä¸‰æ¡ | ä¸‰æ¡å€¼ Ã— 4 | ä¸‰æ¡Q = 12 Ã— 4 = 48 |
| é¡ºå­ | æ‰€æœ‰5å¼ ç‰Œå€¼æ€»å’Œ | 10-J-Q-K-A = 60 |
| åŒèŠ± | æ‰€æœ‰5å¼ ç‰Œå€¼æ€»å’Œ | A-K-J-9-5 = 52 |
| è‘«èŠ¦ | ä¸‰æ¡Ã—5 + å¯¹å­Ã—2 | Aå¸¦K = 14Ã—5 + 13Ã—2 = 96 |
| å››æ¡ | å››æ¡å€¼ Ã— 10 | å››æ¡A = 14 Ã— 10 = 140 |
| åŒèŠ±é¡º | æœ€é«˜ç‰Œå€¼ Ã— 6 | Qé«˜ = 12 Ã— 6 = 72 |
| çš‡å®¶åŒèŠ±é¡º | å›ºå®šå€¼ 100 | 100 |
| äº”æ¡ | äº”æ¡å€¼ Ã— 15 | äº”æ¡A = 14 Ã— 15 = 210 |

### åŠ¨æ€ç­‰çº§ç³»ç»Ÿ

```gdscript
# ç­‰çº§å€ç‡è®¡ç®—å…¬å¼
åŠ¨æ€å€ç‡ = åŸºç¡€å€ç‡ + (å½“å‰ç­‰çº§ - 1) Ã— ç­‰çº§å¢é‡

# ç¤ºä¾‹ï¼šä¸€å¯¹çš„ç­‰çº§å€ç‡
# LV1: 1.2 + (1-1) Ã— 0.2 = 1.2x
# LV3: 1.2 + (3-1) Ã— 0.2 = 1.6x  
# LV5: 1.2 + (5-1) Ã— 0.2 = 2.0x
```

---

## ğŸ”§ æ•°æ®ç»“æ„

### HandResult - ç‰Œå‹è¯†åˆ«ç»“æœ

```gdscript
class HandResult:
    var hand_type: HandType              # ç‰Œå‹æšä¸¾
    var hand_type_name: String           # ç‰Œå‹åç§°
    var primary_value: float             # ä¸»è¦ç‰Œå€¼
    var secondary_value: float           # æ¬¡è¦ç‰Œå€¼  
    var contributing_cards: Array        # æ„æˆç‰Œå‹çš„å…³é”®ç‰Œ
    var all_cards: Array               # æ‰€æœ‰å‚ä¸åˆ†æçš„ç‰Œ
    var description: String             # ç‰Œå‹æè¿°
    var analysis_metadata: Dictionary   # åˆ†æå…ƒæ•°æ®
```

### ScoreResult - å¾—åˆ†è®¡ç®—ç»“æœ

```gdscript
class ScoreResult:
    var final_score: int                # æœ€ç»ˆå¾—åˆ†
    var raw_score: float               # åŸå§‹å¾—åˆ†ï¼ˆèˆå…¥å‰ï¼‰
    var base_score: int                # åŸºç¡€ç‰Œå‹åˆ†
    var value_score: float             # ç‰Œé¢ä»·å€¼åˆ†
    var bonus_score: int               # é™„åŠ åˆ†
    var hand_type_multiplier: float    # ç‰Œå‹å€ç‡
    var final_multiplier: float        # æœ€ç»ˆå€ç‡
    var core_score: float              # æ ¸å¿ƒåˆ†æ•°
    var simple_formula: String         # ç®€åŒ–å…¬å¼
    var detailed_formula: String       # è¯¦ç»†å…¬å¼
    var calculation_steps: Array       # è®¡ç®—æ­¥éª¤
```

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ç‰Œå‹è¯†åˆ«

```gdscript
# åˆ›å»ºå¡ç‰Œæ•°ç»„
var cards = [card1, card2, card3, card4, card5]

# æ‰§è¡Œç‰Œå‹è¯†åˆ«
var hand_result = HandTypeSystemV2.analyze_hand_type(cards)

# è·å–ç»“æœ
print("ç‰Œå‹: %s" % hand_result.hand_type_name)
print("æè¿°: %s" % hand_result.description)
print("ä¸»è¦ç‰Œå€¼: %s" % hand_result.primary_value)
```

### å®Œæ•´å¾—åˆ†è®¡ç®—

```gdscript
# åˆ›å»ºç­‰çº§ç®¡ç†å™¨
var ranking_manager = HandTypeRankingManager.new()
ranking_manager.set_hand_type_level(HandTypeEnums.HandType.PAIR, 3)

# æ‰§è¡Œå®Œæ•´åˆ†æ
var result = HandTypeSystemV2.analyze_and_score(cards, ranking_manager, 0, 1.0)

# è·å–è¯¦ç»†ç»“æœ
var hand_result = result.hand_result
var score_result = result.score_result

print("ç‰Œå‹: %s" % hand_result.hand_type_name)
print("æœ€ç»ˆå¾—åˆ†: %d" % score_result.final_score)
print("è®¡ç®—å…¬å¼: %s" % score_result.detailed_formula)
print("åˆ†æè€—æ—¶: %dms" % result.total_analysis_time)
```

### å¤šå¼ ç‰Œæœ€ä½³ç»„åˆ

```gdscript
# 7å¼ ç‰Œæ‰¾æœ€ä½³5å¼ ç»„åˆ
var cards = [â™ 7, â™¥7, â™¦7, â™£9, â™ 9, â™¥2, â™¦5]
var hand_result = SmartHandAnalyzerV2.find_best_hand(cards)

print("æœ€ä½³ç‰Œå‹: %s" % hand_result.hand_type_name)  # è‘«èŠ¦ 7å¸¦9
print("å…³é”®ç‰Œ: %s" % hand_result.contributing_cards)  # [â™ 7, â™¥7, â™¦7, â™£9, â™ 9]
```

---

## ğŸ§ª æµ‹è¯•ä¸éªŒè¯

### æµ‹è¯•è¦†ç›–èŒƒå›´

ç³»ç»ŸåŒ…å«**23ä¸ªç»¼åˆæµ‹è¯•ç”¨ä¾‹**ï¼Œè¦†ç›–ï¼š
- æ‰€æœ‰11ç§ç‰Œå‹çš„è¯†åˆ«å‡†ç¡®æ€§
- ä¸åŒç­‰çº§çš„å€ç‡è®¡ç®—æ­£ç¡®æ€§  
- V2.3è®¡åˆ†å…¬å¼çš„ç²¾åº¦éªŒè¯
- è¾¹ç•Œæƒ…å†µå’Œç‰¹æ®Šç‰Œå‹å¤„ç†

### æ€§èƒ½æŒ‡æ ‡

- **è¯†åˆ«å‡†ç¡®ç‡**: 100%ï¼ˆ23/23æµ‹è¯•é€šè¿‡ï¼‰
- **å¹³å‡è¯†åˆ«è€—æ—¶**: <1msï¼ˆ5å¼ ç‰Œï¼‰
- **æœ€å¤§ç»„åˆè€—æ—¶**: <15msï¼ˆ13å¼ ç‰Œï¼‰
- **å†…å­˜å ç”¨**: æä½ï¼ˆæ— çŠ¶æ€è®¾è®¡ï¼‰

---

## ğŸ“Š é…ç½®ä¸æ‰©å±•

### åŸºç¡€åˆ†æ•°é…ç½®

```gdscript
# HandTypeEnums.gd - BASE_SCORES
const BASE_SCORES = {
    HandType.HIGH_CARD: 10,
    HandType.PAIR: 25,
    HandType.TWO_PAIR: 50,
    # ... å…¶ä»–ç‰Œå‹
}
```

### ç­‰çº§å€ç‡é…ç½®

```gdscript
# HandTypeEnums.gd - LEVEL_MULTIPLIERS  
const LEVEL_MULTIPLIERS = {
    # ç‰Œå‹: [LV1å€ç‡, æ¯çº§å¢é‡]
    HandType.PAIR: [1.2, 0.2],           # LV1: 1.2x â†’ LV5: 2.0x
    HandType.TWO_PAIR: [1.4, 0.25],      # LV1: 1.4x â†’ LV5: 2.4x
    # ... å…¶ä»–ç‰Œå‹
}
```

### æ‰©å±•æ–°ç‰Œå‹

1. åœ¨`HandTypeEnums.gd`ä¸­æ·»åŠ æ–°æšä¸¾
2. åœ¨`PokerHandAnalyzer.gd`ä¸­æ³¨å†Œæ–°è¯„ä¼°å™¨
3. åœ¨`PreciseScoreCalculator.gd`ä¸­æ·»åŠ è®¡åˆ†é€»è¾‘
4. æ›´æ–°é…ç½®æ•°æ®å’Œæµ‹è¯•ç”¨ä¾‹

---

## ğŸ” è¯¦ç»†å®ç°é€»è¾‘

### ç‰Œå‹è¯„ä¼°å™¨å®ç°

#### 1. çš‡å®¶åŒèŠ±é¡ºè¯„ä¼°å™¨
```gdscript
static func _evaluate_royal_flush(card_data: Dictionary) -> HandResult:
    # æ£€æŸ¥æ˜¯å¦ä¸ºåŒèŠ±
    if not _is_flush(card_data.suits):
        return null

    # æ£€æŸ¥æ˜¯å¦ä¸º10-J-Q-K-Aé¡ºå­
    var royal_values = [10, 11, 12, 13, 14]  # 10, J, Q, K, A
    var sorted_values = card_data.base_values.duplicate()
    sorted_values.sort()

    if sorted_values == royal_values:
        var result = HandResult.new()
        result.set_hand_type(HandType.ROYAL_FLUSH, "çš‡å®¶åŒèŠ±é¡º")
        result.set_core_values(14.0)  # Aä¸ºæœ€é«˜ç‰Œ
        result.contributing_cards = card_data.cards.duplicate()
        return result

    return null
```

#### 2. åŒèŠ±é¡ºè¯„ä¼°å™¨
```gdscript
static func _evaluate_straight_flush(card_data: Dictionary) -> HandResult:
    # æ£€æŸ¥æ˜¯å¦ä¸ºåŒèŠ±
    if not _is_flush(card_data.suits):
        return null

    # æ£€æŸ¥æ˜¯å¦ä¸ºé¡ºå­
    var straight_high = _is_straight(card_data.face_values)
    if straight_high > 0:
        var result = HandResult.new()
        result.set_hand_type(HandType.STRAIGHT_FLUSH, "åŒèŠ±é¡º")
        result.set_core_values(float(straight_high))
        result.contributing_cards = card_data.cards.duplicate()
        return result

    return null
```

#### 3. å››æ¡è¯„ä¼°å™¨
```gdscript
static func _evaluate_four_kind(card_data: Dictionary) -> HandResult:
    var value_counts = _count_values(card_data.face_values)

    for face_value in value_counts:
        if value_counts[face_value] == 4:
            # æ‰¾åˆ°å¯¹åº”çš„base_value
            var base_value = _get_base_value_for_face(face_value, card_data)

            var result = HandResult.new()
            result.set_hand_type(HandType.FOUR_KIND, "å››æ¡")
            result.set_core_values(float(base_value))

            # æ”¶é›†æ„æˆå››æ¡çš„å¡ç‰Œ
            result.contributing_cards = _collect_cards_by_face_value(face_value, card_data.cards, 4)
            return result

    return null
```

#### 4. è‘«èŠ¦è¯„ä¼°å™¨
```gdscript
static func _evaluate_full_house(card_data: Dictionary) -> HandResult:
    var value_counts = _count_values(card_data.face_values)
    var three_kind_value = -1
    var pair_value = -1

    # å¯»æ‰¾ä¸‰æ¡å’Œå¯¹å­
    for face_value in value_counts:
        if value_counts[face_value] == 3:
            three_kind_value = face_value
        elif value_counts[face_value] == 2:
            pair_value = face_value

    if three_kind_value != -1 and pair_value != -1:
        var three_base = _get_base_value_for_face(three_kind_value, card_data)
        var pair_base = _get_base_value_for_face(pair_value, card_data)

        var result = HandResult.new()
        result.set_hand_type(HandType.FULL_HOUSE, "è‘«èŠ¦")
        result.set_core_values(float(three_base), float(pair_base))

        # æ”¶é›†æ„æˆè‘«èŠ¦çš„æ‰€æœ‰å¡ç‰Œ
        var contributing = []
        contributing.append_array(_collect_cards_by_face_value(three_kind_value, card_data.cards, 3))
        contributing.append_array(_collect_cards_by_face_value(pair_value, card_data.cards, 2))
        result.contributing_cards = contributing

        return result

    return null
```

#### 5. ä¸¤å¯¹è¯„ä¼°å™¨
```gdscript
static func _evaluate_two_pair(card_data: Dictionary) -> HandResult:
    var value_counts = _count_values(card_data.face_values)
    var pairs = []

    # æ”¶é›†æ‰€æœ‰å¯¹å­
    for face_value in value_counts:
        if value_counts[face_value] == 2:
            pairs.append(face_value)

    if pairs.size() >= 2:
        # æŒ‰base_valueæ’åºï¼Œå–æœ€å¤§çš„ä¸¤ä¸ªå¯¹å­
        var pair_bases = []
        for face_val in pairs:
            var base_val = _get_base_value_for_face(face_val, card_data)
            pair_bases.append({"face": face_val, "base": base_val})

        # æŒ‰base_valueé™åºæ’åº
        pair_bases.sort_custom(func(a, b): return a.base > b.base)

        var primary_base = pair_bases[0].base
        var secondary_base = pair_bases[1].base

        print("ğŸ” ä¸¤å¯¹è¯„ä¼°å™¨: pairs=%s, primary_base_value=%d, secondary_base_value=%d" % [pairs, primary_base, secondary_base])

        var result = HandResult.new()
        result.set_hand_type(HandType.TWO_PAIR, "ä¸¤å¯¹")
        result.set_core_values(float(primary_base), float(secondary_base))

        # æ”¶é›†æ„æˆä¸¤å¯¹çš„å¡ç‰Œ
        var contributing = []
        contributing.append_array(_collect_cards_by_face_value(pair_bases[0].face, card_data.cards, 2))
        contributing.append_array(_collect_cards_by_face_value(pair_bases[1].face, card_data.cards, 2))
        result.contributing_cards = contributing

        return result

    return null
```

### æ ¸å¿ƒè¾…åŠ©å‡½æ•°

#### é¡ºå­æ£€æµ‹
```gdscript
static func _is_straight(face_values: Array) -> int:
    var sorted_values = face_values.duplicate()
    sorted_values.sort()

    # æ£€æŸ¥æ ‡å‡†é¡ºå­
    for i in range(sorted_values.size() - 1):
        if sorted_values[i + 1] - sorted_values[i] != 1:
            break
        if i == sorted_values.size() - 2:
            return sorted_values[-1]  # è¿”å›æœ€é«˜ç‰Œ

    # æ£€æŸ¥A-2-3-4-5ä½ä½é¡ºå­
    if sorted_values == [1, 2, 3, 4, 5]:
        return 5  # A-5é¡ºå­ï¼Œ5ä¸ºé«˜ç‰Œ

    return 0  # ä¸æ˜¯é¡ºå­
```

#### åŒèŠ±æ£€æµ‹
```gdscript
static func _is_flush(suits: Array) -> bool:
    if suits.is_empty():
        return false

    var first_suit = suits[0]
    for suit in suits:
        if suit != first_suit:
            return false

    return true
```

#### ç‰Œå€¼ç»Ÿè®¡
```gdscript
static func _count_values(values: Array) -> Dictionary:
    var counts = {}
    for value in values:
        if counts.has(value):
            counts[value] += 1
        else:
            counts[value] = 1
    return counts
```

---

## ğŸ¯ æ€»ç»“

V2.3ç‰Œå‹è¯†åˆ«ä¸è®¡ç®—ç³»ç»Ÿæ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œæ•´ã€æ€§èƒ½ä¼˜å¼‚çš„æ‰‘å…‹ç‰Œå‹åˆ†ææ¡†æ¶ã€‚é€šè¿‡æ¨¡å—åŒ–è®¾è®¡ã€æ•°æ®é©±åŠ¨é…ç½®å’Œä¸¥æ ¼çš„æµ‹è¯•éªŒè¯ï¼Œç³»ç»Ÿèƒ½å¤Ÿå‡†ç¡®è¯†åˆ«å„ç§ç‰Œå‹å¹¶è¿›è¡Œç²¾ç¡®çš„å¾—åˆ†è®¡ç®—ï¼Œä¸ºå¥¥æœ¯å­¦é™¢æ‰‘å…‹æ¸¸æˆæä¾›äº†åšå®çš„æŠ€æœ¯åŸºç¡€ã€‚

### ç³»ç»Ÿä¼˜åŠ¿

1. **é«˜ç²¾åº¦è¯†åˆ«**: 100%æµ‹è¯•é€šè¿‡ç‡ï¼Œæ”¯æŒæ‰€æœ‰æ ‡å‡†æ‰‘å…‹ç‰Œå‹
2. **çµæ´»é…ç½®**: æ•°æ®é©±åŠ¨çš„åˆ†æ•°å’Œå€ç‡é…ç½®ï¼Œæ˜“äºè°ƒæ•´å¹³è¡¡æ€§
3. **æ€§èƒ½ä¼˜å¼‚**: æ¯«ç§’çº§è¯†åˆ«é€Ÿåº¦ï¼Œæ”¯æŒå¤§é‡å¡ç‰Œç»„åˆåˆ†æ
4. **æ‰©å±•æ€§å¼º**: æ¨¡å—åŒ–æ¶æ„ï¼Œæ˜“äºæ·»åŠ æ–°ç‰Œå‹å’Œè®¡ç®—é€»è¾‘
5. **ä»£ç è´¨é‡**: æ¸…æ™°çš„æ¶æ„è®¾è®¡ï¼Œå®Œå–„çš„é”™è¯¯å¤„ç†å’Œè°ƒè¯•ä¿¡æ¯

### æŠ€æœ¯ç‰¹è‰²

- **æ™ºèƒ½åˆ†æ**: æ ¹æ®å¡ç‰Œæ•°é‡è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜åˆ†æç­–ç•¥
- **ç²¾ç¡®è®¡ç®—**: æ”¯æŒå°æ•°è®¡ç®—ï¼Œç¡®ä¿å¾—åˆ†ç²¾åº¦
- **åŠ¨æ€ç­‰çº§**: æ¯ä¸ªç‰Œå‹ç‹¬ç«‹çš„ç­‰çº§æˆé•¿ç³»ç»Ÿ
- **å®Œæ•´æµ‹è¯•**: 23ä¸ªæµ‹è¯•ç”¨ä¾‹è¦†ç›–æ‰€æœ‰åŠŸèƒ½ç‚¹
- **æ€§èƒ½ç›‘æ§**: å†…ç½®æ€§èƒ½æŒ‡æ ‡å’Œè°ƒè¯•ä¿¡æ¯

---

## ğŸ“š APIå‚è€ƒ

### HandTypeSystemV2 ç±»

#### analyze_and_score()
```gdscript
static func analyze_and_score(
    cards: Array,
    ranking_manager: HandTypeRankingManager = null,
    bonus_score: int = 0,
    final_multiplier: float = 1.0
) -> Dictionary
```
**å‚æ•°**:
- `cards`: å¡ç‰Œæ•°ç»„ï¼Œæ”¯æŒ1-Nå¼ ç‰Œ
- `ranking_manager`: ç­‰çº§ç®¡ç†å™¨ï¼Œä¸ºnullæ—¶ä½¿ç”¨é»˜è®¤é…ç½®
- `bonus_score`: é™„åŠ åˆ†æ•°ï¼Œé»˜è®¤0
- `final_multiplier`: æœ€ç»ˆå€ç‡ï¼Œé»˜è®¤1.0

**è¿”å›å€¼**: åŒ…å«hand_resultã€score_resultã€åˆ†æè€—æ—¶ç­‰å®Œæ•´ä¿¡æ¯çš„å­—å…¸

#### quick_score()
```gdscript
static func quick_score(
    cards: Array,
    level: int = 1,
    bonus_score: int = 0,
    final_multiplier: float = 1.0
) -> int
```
**å‚æ•°**:
- `cards`: å¡ç‰Œæ•°ç»„
- `level`: ç‰Œå‹ç­‰çº§(1-5)
- `bonus_score`: é™„åŠ åˆ†æ•°
- `final_multiplier`: æœ€ç»ˆå€ç‡

**è¿”å›å€¼**: æœ€ç»ˆå¾—åˆ†æ•´æ•°

### SmartHandAnalyzerV2 ç±»

#### find_best_hand()
```gdscript
static func find_best_hand(cards: Array) -> HandResult
```
**å‚æ•°**:
- `cards`: å¡ç‰Œæ•°ç»„ï¼Œæ”¯æŒ1-Nå¼ ç‰Œ

**è¿”å›å€¼**: HandResultå¯¹è±¡ï¼ŒåŒ…å«ç‰Œå‹è¯†åˆ«çš„å®Œæ•´ä¿¡æ¯

### PreciseScoreCalculator ç±»

#### calculate_score()
```gdscript
static func calculate_score(
    hand_result: HandResult,
    ranking_manager: HandTypeRankingManager,
    bonus_score: int = 0,
    final_multiplier: float = 1.0
) -> ScoreResult
```
**å‚æ•°**:
- `hand_result`: ç‰Œå‹è¯†åˆ«ç»“æœ
- `ranking_manager`: ç­‰çº§ç®¡ç†å™¨
- `bonus_score`: é™„åŠ åˆ†æ•°
- `final_multiplier`: æœ€ç»ˆå€ç‡

**è¿”å›å€¼**: ScoreResultå¯¹è±¡ï¼ŒåŒ…å«è¯¦ç»†çš„å¾—åˆ†è®¡ç®—ä¿¡æ¯

### HandTypeRankingManager ç±»

#### set_hand_type_level()
```gdscript
func set_hand_type_level(hand_type: HandType, level: int) -> bool
```
**å‚æ•°**:
- `hand_type`: ç‰Œå‹æšä¸¾
- `level`: ç­‰çº§(1-5)

**è¿”å›å€¼**: è®¾ç½®æ˜¯å¦æˆåŠŸ

#### get_multiplier()
```gdscript
func get_multiplier(hand_type: HandType) -> float
```
**å‚æ•°**:
- `hand_type`: ç‰Œå‹æšä¸¾

**è¿”å›å€¼**: å½“å‰ç­‰çº§å¯¹åº”çš„å€ç‡

---

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. ç‰Œå‹è¯†åˆ«å¤±è´¥
**ç—‡çŠ¶**: è¿”å›ç©ºçš„HandResultæˆ–HIGH_CARD
**åŸå› **:
- å¡ç‰Œæ•°æ®æ ¼å¼ä¸æ­£ç¡®
- ç¼ºå°‘å¿…è¦çš„face_valueæˆ–base_valueå±æ€§
- å¡ç‰Œæ•°é‡ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**:
```gdscript
# æ£€æŸ¥å¡ç‰Œæ•°æ®æ ¼å¼
for card in cards:
    if not card.has("face_value") or not card.has("base_value"):
        push_error("å¡ç‰Œç¼ºå°‘å¿…è¦å±æ€§: %s" % card)
```

#### 2. å¾—åˆ†è®¡ç®—å¼‚å¸¸
**ç—‡çŠ¶**: å¾—åˆ†ä¸º0æˆ–å¼‚å¸¸å€¼
**åŸå› **:
- HandResultæ— æ•ˆ
- ç­‰çº§ç®¡ç†å™¨é…ç½®é”™è¯¯
- å€ç‡è®¡ç®—æº¢å‡º

**è§£å†³æ–¹æ¡ˆ**:
```gdscript
# éªŒè¯HandResultæœ‰æ•ˆæ€§
if not hand_result.is_valid():
    push_error("HandResultæ— æ•ˆ: %s" % hand_result)

# æ£€æŸ¥ç­‰çº§èŒƒå›´
if level < 1 or level > 5:
    push_error("ç­‰çº§è¶…å‡ºèŒƒå›´: %d" % level)
```

#### 3. æ€§èƒ½é—®é¢˜
**ç—‡çŠ¶**: åˆ†æè€—æ—¶è¿‡é•¿
**åŸå› **:
- å¡ç‰Œæ•°é‡è¿‡å¤š(>13å¼ )
- é¢‘ç¹åˆ›å»ºä¸´æ—¶å¯¹è±¡
- é€’å½’æ·±åº¦è¿‡æ·±

**è§£å†³æ–¹æ¡ˆ**:
```gdscript
# é™åˆ¶å¡ç‰Œæ•°é‡
if cards.size() > 13:
    push_warning("å¡ç‰Œæ•°é‡è¿‡å¤šï¼Œå¯èƒ½å½±å“æ€§èƒ½: %då¼ " % cards.size())

# ä½¿ç”¨å¯¹è±¡æ± 
var result_pool = []  # å¤ç”¨HandResultå¯¹è±¡
```

### è°ƒè¯•æŠ€å·§

#### å¯ç”¨è¯¦ç»†æ—¥å¿—
```gdscript
# åœ¨PokerHandAnalyzerä¸­å¯ç”¨è°ƒè¯•è¾“å‡º
const DEBUG_MODE = true

if DEBUG_MODE:
    print("ğŸ¯ è¯†åˆ«åˆ°ç‰Œå‹: %s" % result.hand_type_name)
    print("ğŸ” å…³é”®ç‰Œ: %s" % result.contributing_cards)
```

#### æ€§èƒ½ç›‘æ§
```gdscript
# ç›‘æ§åˆ†æè€—æ—¶
var start_time = Time.get_ticks_msec()
var result = HandTypeSystemV2.analyze_and_score(cards)
var end_time = Time.get_ticks_msec()

if end_time - start_time > 10:  # è¶…è¿‡10ms
    push_warning("åˆ†æè€—æ—¶è¿‡é•¿: %dms" % (end_time - start_time))
```

#### æ•°æ®éªŒè¯
```gdscript
# éªŒè¯è®¡ç®—ç»“æœ
func validate_score_result(score_result: ScoreResult) -> bool:
    if score_result.final_score < 0:
        push_error("æœ€ç»ˆå¾—åˆ†ä¸ºè´Ÿæ•°: %d" % score_result.final_score)
        return false

    if score_result.hand_type_multiplier <= 0:
        push_error("å€ç‡å¼‚å¸¸: %f" % score_result.hand_type_multiplier)
        return false

    return true
```

---

## ğŸ“ˆ ç‰ˆæœ¬å†å²

### V2.3 (å½“å‰ç‰ˆæœ¬)
- âœ… å¢å¼ºçš„åŸºç¡€åˆ†æ•°ç³»ç»Ÿ(10-3000)
- âœ… åŠ¨æ€ç­‰çº§ç³»ç»Ÿä¼˜åŒ–
- âœ… ä¸¤é˜¶æ®µè®¡åˆ†æ¨¡å‹
- âœ… å°æ•°è®¡ç®—æ”¯æŒ
- âœ… 100%æµ‹è¯•è¦†ç›–ç‡

### V2.2 (å†å²ç‰ˆæœ¬)
- åŸºç¡€ç‰Œå‹è¯†åˆ«ç³»ç»Ÿ
- ç®€å•å¾—åˆ†è®¡ç®—
- é™æ€å€ç‡é…ç½®

### V2.1 (å†å²ç‰ˆæœ¬)
- åˆå§‹æ¶æ„è®¾è®¡
- æ ¸å¿ƒç»„ä»¶åˆ†ç¦»
- åŸºç¡€æµ‹è¯•æ¡†æ¶

---

## ğŸ”® æœªæ¥è§„åˆ’

### çŸ­æœŸç›®æ ‡
- [ ] æ”¯æŒæ›´å¤šç‰¹æ®Šç‰Œå‹(å¦‚åŒèŠ±å¤§é¡º)
- [ ] ä¼˜åŒ–å¤§é‡å¡ç‰Œçš„åˆ†ææ€§èƒ½
- [ ] å¢åŠ æ›´å¤šè°ƒè¯•å’Œç›‘æ§å·¥å…·

### é•¿æœŸç›®æ ‡
- [ ] æ”¯æŒå¤šäººæ¸¸æˆçš„ç‰Œå‹æ¯”è¾ƒ
- [ ] å®ç°AIè¾…åŠ©çš„æœ€ä¼˜ç­–ç•¥åˆ†æ
- [ ] é›†æˆæœºå™¨å­¦ä¹ çš„ç‰Œå‹é¢„æµ‹

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰æŠ€æœ¯é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿæˆ–æŸ¥é˜…ç›¸å…³æ–‡æ¡£ï¼š

- ğŸ“– **APIæ–‡æ¡£**: `docs/ç‰Œå‹è¯†åˆ«ç³»ç»ŸAPIå‚è€ƒ.md`
- ğŸ§ª **æµ‹è¯•æ–‡æ¡£**: `cs/tests/å¡ç‰Œç›¸å…³/ç‰Œå‹è¯†åˆ«æµ‹è¯•/æµ‹è¯•æ–‡æ¡£.md`
- ğŸ”§ **é…ç½®æ–‡æ¡£**: `cs/å¡ç‰Œç³»ç»Ÿ/æ•°æ®/HandTypeEnums.gd`
- ğŸ“Š **æ€§èƒ½æŠ¥å‘Š**: è¿è¡Œæµ‹è¯•åœºæ™¯è·å–æœ€æ–°æ€§èƒ½æ•°æ®
