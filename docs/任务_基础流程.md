# åŸºç¡€æµç¨‹å®ç°è®¾è®¡æ–‡æ¡£

> ç›®æ ‡ï¼šå®ç°ã€Œå¼€å±€å‘ 5 å¼ ç‰Œ â†’ å¤šé€‰æ‰“å‡º/å¼ƒç½® â†’ ç›´åˆ°å¾—åˆ† â‰¥50 é€šå…³ã€å®Œæ•´å¯ç©å¾ªç¯ã€‚  
> é€‚ç”¨ä»£ç åº“ï¼šå¡ç‰ŒåŸºç¡€ @ 2025-06-14  
> é¢„è®¡å·¥æœŸï¼š1.5 äººæ—¥ï¼ˆå«æµ‹è¯•ï¼‰

---

## 1. æ¸¸æˆè§„åˆ™æ‘˜è¦
| é¡¹ç›® | åˆå§‹å€¼ | å˜åŒ–è§„åˆ™ |
| ---- | ------ | -------- |
| ç‰Œåº“ | 52 å¼  | æŠ½/è¡¥ç‰Œæ—¶å‡å°‘ï¼Œä¸º 0 æ—¶ä¸å†è¡¥å…… |
| æ‰‹ç‰Œ | 5 å¼  | å¼€å±€æŠ½ 5ï¼›æ¯æ‰“å‡º/å¼ƒç½®åè‡ªåŠ¨è¡¥è‡³æ‰‹ç‰Œä¸Šé™ 5ï¼ˆè‹¥ç‰Œåº“ä¸è¶³åˆ™å…¨éƒ¨æŠ½å®Œï¼‰ |
| é›†ä¸­åŠ› (focus) | 5 | **æ¯æ¬¡æ‰§è¡Œâ€œæ‰“å‡ºå·²é€‰â€æ“ä½œ** æ¶ˆè€— 1ï¼›ä¸è¶³åˆ™ä¸èƒ½æ“ä½œ |
| ç²¾å (essence) | 3 | **æ¯æ¬¡æ‰§è¡Œâ€œå¼ƒç½®å·²é€‰â€æ“ä½œ** æ¶ˆè€— 1ï¼›ä¸è¶³åˆ™ä¸èƒ½æ“ä½œ |
| å¾—åˆ† | 0 | æ‰“å‡ºä¸€å¼ ç‰Œå¾—å…¶ `point` æ•°å€¼ï¼›ç›®æ ‡ â‰¥50 å³èƒœåˆ© |

---

## 2. å·²æœ‰å®ç° vs å¾…å®ç°
| æ¨¡å— | å·²æœ‰ | å¾…å®ç° |
| ---- | ---- | ------- |
| `GameManager.gd` | èµ„æºå­—æ®µã€ä¿¡å·ç³»ç»Ÿ | â‘  æ–°å¢ `focus`, `essence`, `score`, `deck_size` å­—æ®µ; â‘¡ `signal resources_changed()`, `score_changed()`, `game_won()` |
| `CardData.gd` | `id/name/cost/effect_id` | â‘  æ–°å¢ `point:int` é»˜è®¤ 1 |
| `CardManager.gd` (æ§åˆ¶) | æŠ½ç‰Œ/ç”Ÿæˆè§†å›¾ | â‘  `deal_initial_hand(5)`; â‘¡ `draw_to_hand(max_size)`; â‘¢ `selected_cards:Array` ç®¡ç†å¤šé€‰ |
| `CardView.gd` (è§†å›¾) | ç‚¹å‡»é€‰ä¸­å•å¼  | â‘  æ”¯æŒå¤šé€‰ï¼šé€‰ä¸­åˆ‡æ¢ `is_selected` å¹¶é«˜äº®; Emit `selection_changed(card,is_selected)` |
| `Hud.gd` | èµ„æº/å¾—åˆ† Label | â‘  ç»‘å®š `GameManager.resources_changed`ã€`score_changed`; â‘¡ æ›´æ–°æŒ‰é’®å¯ç”¨çŠ¶æ€ |
| `UIManager.gd` | Hud å®ä¾‹åŒ– | â‘  æ–°å¢â€œæ‰“å‡º(P) / å¼ƒç½®(D)â€æŒ‰é’®; â‘¡ è¿æ¥ä¿¡å·è‡³ `CardManager` |
| `MainGame.gd` | æ§åˆ¶æµç¨‹ | â‘  é‡ç½®èµ„æº/ç‰Œåº“; â‘¡ èƒœåˆ©æ£€æµ‹ï¼š`GameManager.game_won` â†’ å¼¹çª— |
| æµ‹è¯• (GUT) | æ—  | â‘  `test_deck_draw.gd`: æŠ½ç‰Œå deck_size é€’å‡; â‘¡ `test_score.gd`: è¿ç»­æ‰“å‡ºè·å¾—æ­£ç¡®åˆ†æ•° |

---

## 3. æ•°æ®ç»“æ„ä¸ä¿¡å·
### 3.1 GameManager è¿½åŠ 
```gdscript
var focus:int = 5
var essence:int = 3
var score:int = 0
var deck_size:int = 52

signal resources_changed(focus, essence, deck_size)
signal score_changed(new_score)
signal game_won()
```
### 3.2 CardManager å…³é”®å±æ€§
```gdscript
var selected_cards:Array[CardView] = []
```

---

## 4. æµç¨‹å®ç°æ­¥éª¤
### 4.1 åˆå§‹åŒ– (MainGame)
1. `GameManager.reset_game_state()` â†’ è®¾ç½®èµ„æº/å¾—åˆ†/ç‰Œåº“ã€‚  
2. `card_manager.deal_initial_hand(5)`ã€‚

### 4.2 é€‰æ‹©ä¸æ“ä½œ (CardManager)
```gdscript
func on_card_clicked(card:CardView):
    card.toggle_select()
    if card.is_selected:
        selected_cards.append(card)
    else:
        selected_cards.erase(card)
    emit_signal("selection_updated", selected_cards)
```

#### æ‰“å‡º
```gdscript
func play_selected():
    if GameManager.focus <= 0:
        return
    GameManager.focus -= 1  # ä»…æ‰£ä¸€æ¬¡
    for c in selected_cards:
        GameManager.score += c.data.point
        _move_to_play_area(c)
    _after_action()
```

#### å¼ƒç½®
```gdscript
func discard_selected():
    if GameManager.essence <= 0:
        return
    GameManager.essence -= 1  # ä»…æ‰£ä¸€æ¬¡
    for c in selected_cards:
        _move_to_discard(c)
    _after_action()
```

#### å…±ç”¨è¡¥ç‰Œ
```gdscript
func _after_action():
    selected_cards.clear()
    draw_to_hand(5)
    GameManager._emit_resource_score()
```

### 4.3 GameManager è¾…åŠ©
```gdscript
func _emit_resource_score():
    emit_signal("resources_changed", focus, essence, deck_size)
    emit_signal("score_changed", score)
    if score >= 50:
        emit_signal("game_won")
```

### 4.4 Hud ç»‘å®š
```gdscript
GameManager.resources_changed.connect(_update_resource_labels)
GameManager.score_changed.connect(_update_score)
```
åŒæ—¶æ ¹æ® `focus`/`essence` æ§åˆ¶æŒ‰é’® `disabled` çŠ¶æ€ã€‚

### 4.5 UIï¼ˆä»¥ç°æœ‰ `MainGame.tscn` å¸ƒå±€ä¸ºå‡†ï¼‰Manager æ–°æŒ‰é’®
- æ‰“å‡º (`PlayBtn`)ï¼Œå¿«æ·é”® **P**ï¼Œç‚¹å‡» â†’ `CardManager.play_selected()`ã€‚
- å¼ƒç½® (`DiscardBtn`)ï¼Œå¿«æ·é”® **D**ï¼Œç‚¹å‡» â†’ `CardManager.discard_selected()`ã€‚

### 4.6 èƒœåˆ©ç•Œé¢
`GameManager.game_won` â†’ `UIManager.show_popup("ğŸ‰ ç›®æ ‡è¾¾æˆï¼", callback=restart)`ã€‚

---

## 5. ä»£ç ä¿®æ”¹ä¸€è§ˆ
| æ–‡ä»¶ | å˜æ›´ | å¤‡æ³¨ |
| ---- | ---- | ---- |
| `cs/å…¨å±€/GameManager.gd` | +40 è¡Œ | æ–°å¢å­—æ®µ + ä¿¡å· + èµ„æº/å¾—åˆ†é€»è¾‘ |
| `cs/å¡ç‰Œç³»ç»Ÿ/æ•°æ®/CardData.gd` | +1 å­—æ®µ | `@export var point:int = 1` |
| `cs/å¡ç‰Œç³»ç»Ÿ/æ§åˆ¶/CardManager.gd` | +é€‰ä¸­æ•°ç»„ + æ–°å‡½æ•° 4 ä¸ª | play/discard/draw_to_hand |
| `cs/å¡ç‰Œç³»ç»Ÿ/è§†å›¾/CardView.gd` | +`is_selected` & é«˜äº® | toggle_select() |
| `cs/ä¸»åœºæ™¯/ui/Hud.gd` | +æ›´æ–° Label é€»è¾‘ | _update_resource_labels |
| `cs/ä¸»åœºæ™¯/ui/UIManager.gd` | +2 æŒ‰é’®å®ä¾‹åŒ– & ä¿¡å· | |
| `test/test_deck_draw.gd` | new | GUT å•å…ƒæµ‹è¯• |
| `test/test_score.gd` | new | GUT å•å…ƒæµ‹è¯• |

---

## 6. æµ‹è¯•è®¡åˆ’
1. **Unit**ï¼š`GameManager` åˆå§‹åŒ–ã€èµ„æºæ‰£å‡ã€èƒœåˆ©åˆ¤æ–­ã€‚  
2. **Integration**ï¼šæ¨¡æ‹Ÿç‚¹å‡» 5 å¼ ç‰Œ â†’ play â†’ å¾—åˆ†=5ã€ç‰Œåº“=47ã€focus=0ã€‚  
3. **UI**ï¼š`Hud` Label æ–‡æœ¬ä¸èµ„æºä¸€è‡´ï¼›æŒ‰é’®ç¦ç”¨é€»è¾‘æ­£ç¡®ã€‚  

---

## 7. é‡Œç¨‹ç¢‘ & äº¤ä»˜
| æ—¶é—´ | è¾“å‡º |
| ---- | ---- |
| D+0.5d | å®Œæˆ GameManager/CardManager/CardView ä»£ç  & æœ¬åœ°è·‘é€š |
| D+1.0d | å®Œæˆ UI/Hud/æŒ‰é’® & èƒœåˆ©å¼¹çª— |
| D+1.5d | ç¼–å†™å¹¶é€šè¿‡æµ‹è¯•ï¼Œæ›´æ–°æ–‡æ¡£ & PR åˆå¹¶ |

> **äº¤ä»˜ç‰©**ï¼šæºä»£ç ã€GUT æµ‹è¯•ã€æ›´æ–°åçš„ç”¨æˆ·æŒ‡å— READMEã€æ¼”ç¤º GIFã€‚
