---
描述: 阶段二：核心游戏循环与玩家状态
---

# 阶段二：核心游戏循环与玩家状态

> 本文档基于《奥术学院扑克——分阶段实现指南 (v1.6)》以及 `docs/下一步开发目标.md`，详细列出阶段二的开发任务、目录变更、验收标准与推荐实施顺序。

## 1. 背景
阶段一已完成数据结构重构与卡牌视觉强化。接下来需实现完整的游戏流程（学年→学期→研习→商店→考核）并管理玩家能力与牌型等级。

## 2. 总体目标
1. 重构并精简 `GameManager`，专注流程与玩家状态。
2. 实现 `EventManager` Buff/Debuff 系统。
3. 实现 `CardManager` 及牌库/手牌/弃牌堆逻辑。
4. 扩展 `ScoreCalculator` 使其支持牌型倍率与等级。
5. 打通 UI 场景流转并完成信号交互。

## 3. 任务拆解与清单

### 3.1 GameManager 重构
- **文件**: `cs/全局/GameManager.gd`
- **关键字段**:
  - `current_year:int`, `current_term:int`, `lore_points:int`, `player_score:int`
  - `card_type_levels:Dictionary<String,int>`
- **核心流程方法**:
  - `start_new_year()`, `start_term()`, `end_term()`, `start_wisdom_hall()`, `start_assessment()`
  - `game_won()`, `game_lost()`
- **信号**:
  - `new_year_started(year)`, `term_started(term_type)`, `term_ended()`
  - `wisdom_hall_opened()`, `assessment_started(year)`
  - `game_state_changed(state_dict)`, `lore_changed(points)`
  - `card_type_levels_changed(levels)`
- **验收**:
  - 单元测试脚本能完整跑完一年 → 一学期流程并触发对应信号。

### 3.2 EventManager 实现
- **文件**: `cs/Global/EventManager.gd`
- **字段**:
  - `active_term_buffs:Array`, `active_turn_buffs:Array`, `active_debuffs:Array`
- **方法**:
  - `add_term_buff(buff_dict)`, `add_turn_buff(buff_dict)`
  - `clear_turn_buffs()`, `clear_term_buffs()`
  - `trigger_random_event()`
- **信号**:
  - `buff_applied(buff)`, `debuff_applied(debuff)`
  - `random_event_triggered(id, description)`
- **验收**:
  - 在调试场景中手动触发随机事件并观察 Buff 生效与清理。

### 3.3 CardManager 构建
- **文件**: `cs/卡牌系统/控制/CardManager.gd`
- **字段**:
  - `deck:Array[CardData]`, `discard_pile:Array[CardData]`, `hand:Array[CardData]`, `destroyed_pile:Array[CardData]`
- **方法**:
  - `draw(count:int)`, `discard(index:int)`, `play_card(index:int)`
  - `shuffle_deck()`, `add_card_to_deck(card_data)`, `remove_card_from_deck(card_id)`
- **信号**:
  - `hand_changed(hand:Array)`, `deck_changed(size:int)`, `card_played(card_data)`
- **验收**:
  - 抽牌/弃牌/打牌流程可在最小场景中运行。

### 3.4 ScoreCalculator 扩展
- **文件**: `cs/Global/ScoreCalculator.gd`
- **新增接口**:
  - `calculate_combination_score(cards:Array) -> int`
- **验收**:
  - 提供单元测试用例覆盖所有牌型与等级倍率。

### 3.5 UI 场景流转
- **场景**: `scenes/MainGame.tscn` 及子场景
- **需求**:
  - HUD 显示学年/学期/分数/传说点数
  - Wisdom Hall（商店）界面
  - Assessment（考核）界面
  - 全部通过信号驱动切换
- **验收**:
  - 手动执行一年流程，界面正确切换且数据实时刷新。

## 4. 目录与资源变更
```
cs/
├── Global/
│   ├── EventManager.gd
│   └── ScoreCalculator.gd (扩展)
├── 全局/
│   └── GameManager.gd (精简重构)
├── 卡牌系统/
│   └── 控制/
│       └── CardManager.gd (新建)
scenes/
└── MainGame.tscn (+子场景修改)
```

## 5. 推荐实施顺序
1. GameManager → 2. EventManager → 3. CardManager & ScoreCalculator → 4. UI 场景 → 5. 调试与优化。

## 6. 时间预估 (示例)
| 任务 | 预计工时 |
|------|---------|
| GameManager 重构 | 1 天 |
| EventManager | 0.5 天 |
| CardManager + ScoreCalculator | 1 天 |
| UI 场景流转 | 1 天 |
| 测试 & 调整 | 0.5 天 |

## 7. 验收标准
- 所有单元测试通过，关键信号触发正确。
- 最小可运行 Demo 能从“新学年”顺畅跑到“考核”结束。
- UI 显示与数据同步无明显错误。

## 8. 调试与测试建议
- 在 `res://debug/` 目录下建立临时测试场景与脚本，便于快速验证各模块。
- 利用 Godot Remote SceneTree Inspector 观察节点状态与信号。
- 开启 Godot Profiler 检查性能瓶颈。

---
完成本阶段后，即可进入 **阶段三：高级卡牌操作与分数计算**，实现复杂强化效果链与完整能力体系。
