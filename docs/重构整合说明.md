# 奥术学院扑克 - 代码重构整合说明

## 整合背景与目的

为了使项目结构更加清晰，符合MVC架构设计模式，我们将原先分散在多个目录下的数据定义和管理器类整合到了`cs/卡牌系统/数据`目录中。这种整合有以下几个好处：

1. **提高代码组织性** - 将相关的数据模型和管理器集中在一起，使代码结构更加清晰
2. **减少重复代码** - 消除了多处定义相同数据模型的问题
3. **简化引用路径** - 统一引用路径，减少混淆
4. **符合MVC架构** - 明确区分数据模型(Model)、视图(View)和控制器(Controller)

## 整合内容

### 已整合的文件

| 原路径 | 新路径 |
|-------|-------|
| cs/主场景/abilities/ArtifactData.gd | cs/卡牌系统/数据/ArtifactData.gd |
| cs/主场景/abilities/JokerData.gd | cs/卡牌系统/数据/JokerData.gd |
| cs/主场景/abilities/SpellData.gd | cs/卡牌系统/数据/SpellData.gd |
| cs/主场景/card/CardEffectManager.gd | cs/卡牌系统/数据/管理器/CardEffectManager.gd |
| cs/主场景/card/CardManager.gd | cs/卡牌系统/数据/管理器/CardManager.gd |
| cs/主场景/discovery/DiscoveryManager.gd | cs/卡牌系统/数据/管理器/DiscoveryManager.gd |
| cs/主场景/joker/JokerManager.gd | cs/卡牌系统/数据/管理器/JokerManager.gd |

### 修复的问题

1. 修复了数据类中`effect_value_param`的类型问题，将其从固定类型改为可变类型(`null`)
2. 确保所有数据类都正确导入了`GlobalEnums`
3. 解决了类名冲突问题，确保每个类名只在一个文件中定义

## 整合后的结构

```
cs/卡牌系统/数据/
├── ArtifactData.gd       # 法器数据定义
├── CardData.gd           # 卡牌数据定义
├── JokerData.gd          # 守护灵数据定义
├── README.md             # 数据目录说明文档
├── SpellData.gd          # 法术数据定义
└── 管理器/
    ├── CardEffectManager.gd  # 卡牌效果管理器
    ├── CardManager.gd        # 卡牌管理器
    ├── DiscoveryManager.gd   # 发现系统管理器
    ├── JokerManager.gd       # 守护灵管理器
    └── README.md             # 管理器目录说明文档
```

## 辅助工具

为了帮助完成整合过程，我们创建了以下工具脚本：

1. `cs/工具/UpdateReferences.gd` - 更新项目中对旧文件的引用
2. `cs/工具/CheckClassConflicts.gd` - 检查项目中是否有类名冲突
3. `cs/工具/CleanupOldFiles.gd` - 删除已经移动到新位置的旧文件

这些工具可以在Godot编辑器中通过"脚本 > 运行"菜单执行。

## 使用新整合的代码

### 数据模型

数据模型的使用方式保持不变，只是引用路径发生了变化：

```gdscript
# 创建法器
var artifact = ArtifactData.new()
artifact.item_name = "魔力水晶"
artifact.effect_type_id = "MANA_BOOST"
artifact.effect_value_param = 5

# 创建守护灵
var joker = JokerData.new()
joker.item_name = "时间术士"
joker.trigger_event_timing = GlobalEnums.EffectTriggerTiming.ON_TURN_START
```

### 管理器类

管理器类的使用方式也保持不变：

```gdscript
# 在MainGame.gd中
var card_manager = CardManager.new(self)
var joker_manager = JokerManager.new(self)

func _ready():
    # 设置UI容器
    card_manager.setup(hand_container)
    joker_manager.setup(joker_container)
    
    # 初始化
    card_manager.initialize()
    joker_manager.initialize_jokers()
```

## 注意事项

1. **重新打开项目** - 整合完成后，请保存所有文件并重新打开项目，以确保所有更改生效
2. **检查类名冲突** - 如果遇到编译错误，请运行`CheckClassConflicts.gd`检查是否有类名冲突
3. **更新引用** - 如果发现某些功能不正常，可能是引用路径没有正确更新，请运行`UpdateReferences.gd`

## 后续工作

1. 继续完善MVC架构，进一步分离视图和控制逻辑
2. 优化管理器类之间的交互，减少耦合
3. 考虑使用依赖注入等模式，提高代码的可测试性 