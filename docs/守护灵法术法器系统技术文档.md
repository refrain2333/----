# 🎭 奥术学院扑克 - 守护灵、法术与法器系统技术文档

## 📋 系统概述

奥术学院扑克的守护灵、法术与法器系统是游戏的核心增强机制，为玩家提供多样化的策略选择和游戏体验。这三个系统通过**数据驱动设计**和**模块化架构**，实现了灵活的效果配置和扩展能力。

### 🏗️ 系统架构

```
能力系统 (Abilities System)
├── 守护灵系统 (Joker System)
│   ├── JokerData.gd (数据模型)
│   ├── JokerView.gd (视图组件)
│   └── JokerManager.gd (管理器)
├── 法术系统 (Spell System)
│   ├── SpellData.gd (数据模型)
│   ├── SpellView.gd (视图组件)
│   └── SpellManager.gd (管理器)
└── 法器系统 (Artifact System)
    ├── ArtifactData.gd (数据模型)
    ├── ArtifactItem.gd (视图组件)
    └── DiscoveryManager.gd (管理器)
```

### 🎮 核心特性

- **数据驱动配置**: 所有能力通过`.tres`文件配置，支持热更新
- **效果触发系统**: 基于时机的灵活触发机制
- **稀有度系统**: 四级稀有度（普通、稀有、史诗、传说）
- **充能机制**: 法术支持多次使用和充能管理
- **UI集成**: 完整的视图组件和交互系统

---

## 🎭 守护灵系统 (Joker System)

### 数据模型 - JokerData

守护灵是提供被动效果的永久性增强，在特定时机自动触发。

<augment_code_snippet path="cs/卡牌系统/数据/JokerData.gd" mode="EXCERPT">
````gdscript
class_name JokerData
extends Resource

# 守护灵基本属性（符合v1.6规范）
@export var id: String = ""               # 例如 "JOKER_TIME_WIZARD"
@export var name: String = ""             # 例如 "时间术士"
@export var description: String = ""      # 用于UI显示的描述文本
@export var cost: int = 0                 # 购买费用

# 效果属性（符合v1.6规范）
@export var effect_type: String = ""      # 例如 "ADD_XP_PER_PAIR"
@export var effect_value = null           # 效果参数

# 守护灵特有属性（符合v1.6规范）
@export var trigger_timing: int = GlobalEnums.EffectTriggerTiming.ON_SCORE_CALCULATION # 触发时机
````
</augment_code_snippet>

### 触发时机

守护灵支持多种触发时机：

| 触发时机 | 枚举值 | 描述 | 使用场景 |
|----------|--------|------|----------|
| 回合开始 | ON_TURN_START | 每回合开始时触发 | 资源生成、状态重置 |
| 打牌前 | BEFORE_PLAY | 打出卡牌前触发 | 卡牌强化、预处理 |
| 得分计算 | ON_SCORE_CALCULATION | 计算得分时触发 | 分数加成、倍率修改 |
| 回合结束 | ON_TURN_END | 每回合结束时触发 | 清理效果、延迟触发 |
| 抽牌时 | ON_DRAW | 抽取卡牌时触发 | 抽牌增强、卡牌修改 |
| 弃牌时 | ON_DISCARD | 弃置卡牌时触发 | 资源回收、特殊效果 |

### 示例配置

<augment_code_snippet path="assets/data/jokers/pair_master.tres" mode="EXCERPT">
````tres
[gd_resource type="Resource" script_class="JokerData" load_steps=2 format=3]

[resource]
script = ExtResource("1_sjtcv")
item_id = "JOKER_PAIR_MASTER"
item_name = "对子大师"
description_text = "打出对子时，基础分值提高30%。"
rarity_type = 1
purchase_cost = 35
effect_type_id = "CARD_TYPE_MULTIPLIER_PAIR"
effect_value_param = 0.3
trigger_event_timing = 3
````
</augment_code_snippet>

### 管理器 - JokerManager

<augment_code_snippet path="cs/卡牌系统/数据/管理器/JokerManager.gd" mode="EXCERPT">
````gdscript
class_name JokerManager
extends Node

# 初始化守护灵区域
func initialize_jokers():
    joker_container.set_meta("max_jokers", GameManager.joker_slots)
    update_joker_count()

# 更新守护灵显示
func update_joker_display():
    # 清空当前守护灵区域
    for child in joker_container.get_children():
        child.queue_free()
    
    # 创建并放置守护灵
    for i in range(GameManager.active_jokers.size()):
        var joker_data = GameManager.active_jokers[i]
        var joker_instance = joker_card_scene.instantiate()
        joker_container.add_child(joker_instance)
        joker_instance.setup(joker_data)
````
</augment_code_snippet>

---

## 🔮 法术系统 (Spell System)

### 数据模型 - SpellData

法术是可主动使用的能力，分为瞬发法术和技能区法术两种类型。

<augment_code_snippet path="cs/卡牌系统/数据/SpellData.gd" mode="EXCERPT">
````gdscript
class_name SpellData
extends Resource

# 法术基本属性（符合v1.6规范）
@export var id: String = ""               # 例如 "SPELL_FLASH_OF_INSIGHT"
@export var name: String = ""             # 例如 "灵光一闪"
@export var description: String = ""      # 用于UI显示的描述文本
@export var rarity: int = GlobalEnums.Rarity.COMMON # 稀有度
@export var cost: int = 0                 # 购买费用

# 效果属性（符合v1.6规范）
@export var effect_type: String = ""      # 例如 "DOUBLE_SCORE"
@export var effect_value = null           # 效果参数

# 法术特有属性（符合v1.6规范）
@export var spell_type: int = GlobalEnums.SpellType.INSTANT_USE # 法术类型
@export var charges: int = 1              # 当前使用次数/充能
````
</augment_code_snippet>

### 法术类型

| 类型 | 枚举值 | 描述 | 特点 |
|------|--------|------|------|
| 瞬发法术 | INSTANT_USE | 立即使用并消耗 | 一次性效果，使用后消失 |
| 技能区法术 | ACTIVE_SKILL | 放置在技能区 | 可多次使用，有充能限制 |

### 充能机制

<augment_code_snippet path="cs/卡牌系统/数据/SpellData.gd" mode="EXCERPT">
````gdscript
# 使用法术，消耗一次充能
func use() -> bool:
    if charges <= 0:
        return false
    
    charges -= 1
    return true

# 增加充能
func add_charge(amount: int = 1) -> void:
    charges += amount
````
</augment_code_snippet>

### 示例配置

<augment_code_snippet path="assets/data/spells/flash_of_insight.tres" mode="EXCERPT">
````tres
[gd_resource type="Resource" script_class="SpellData" load_steps=2 format=3]

[resource]
script = ExtResource("1_e74wk")
id = "SPELL_FLASH_OF_INSIGHT"
name = "灵感闪现"
description = "立即抽取3张牌。"
rarity = 1
cost = 25
effect_type = "DRAW_CARDS"
effect_value = 3
spell_type = 0
charges = 1
````
</augment_code_snippet>

---

## ⚔️ 法器系统 (Artifact System)

### 数据模型 - ArtifactData

法器是提供持续性被动效果的装备，通常影响游戏的基础机制。

<augment_code_snippet path="cs/卡牌系统/数据/ArtifactData.gd" mode="EXCERPT">
````gdscript
class_name ArtifactData
extends Resource

# 法器基本属性（符合v1.6规范）
@export var id: String = ""               # 例如 "ARTIFACT_MAGIC_CRYSTAL"
@export var name: String = ""             # 例如 "魔力水晶"
@export var description: String = ""      # 用于UI显示的描述文本
@export var rarity: int = GlobalEnums.Rarity.COMMON # 稀有度
@export var cost: int = 0                 # 购买费用

# 效果属性（符合v1.6规范）
@export var effect_type: String = ""      # 例如 "LORE_POINTS_PERCENT_BONUS"
@export var effect_value = null           # 效果参数，如 0.05 (5%) 或 1 (增加1点)
````
</augment_code_snippet>

### 示例配置

<augment_code_snippet path="assets/data/artifacts/apprentice_notes.tres" mode="EXCERPT">
````tres
[gd_resource type="Resource" script_class="ArtifactData" load_steps=2 format=3]

[resource]
script = ExtResource("1_data")
id = "ARTIFACT_APPRENTICE_NOTES"
name = "学徒笔记"
description = "每获得一张牌，额外获得5%传说点数。"
rarity = 0
cost = 25
effect_type = "LORE_POINTS_PERCENT_BONUS"
effect_value = 0.05
````
</augment_code_snippet>

### 管理器 - DiscoveryManager

<augment_code_snippet path="cs/卡牌系统/数据/管理器/DiscoveryManager.gd" mode="EXCERPT">
````gdscript
# 初始化传奇法器区域
func initialize_artifacts():
    # 设置容器的属性，为后续动态添加法器做准备
    artifact_container.set_meta("max_artifacts", GameManager.max_artifacts)  # 最多可添加6个法器
    artifact_container.set_meta("artifact_size", Vector2(135, 180))  # 法器标准尺寸
    
    # 更新计数器显示
    update_artifact_count()

# 添加新的传奇法器
func add_artifact(artifact_data):
    # 使用GameManager添加传奇法器
    if not GameManager.add_artifact(artifact_data):
        print("警告：已达到最大传奇法器数量")
        return
````
</augment_code_snippet>

---

## 🎯 效果系统

### 效果类型

系统支持多种效果类型，通过字符串ID进行标识：

| 效果类型 | ID | 描述 | 适用系统 |
|----------|----|----- |----------|
| 分数百分比加成 | SCORE_PERCENT_BONUS | 最终分数增加X% | 守护灵、法器 |
| 传说点数加成 | LORE_POINTS_PERCENT_BONUS | 传说点数获得增加X% | 法器 |
| 抽牌效果 | DRAW_CARDS | 立即抽取X张牌 | 法术 |
| 牌型倍率加成 | CARD_TYPE_MULTIPLIER_X | 特定牌型分数增加X% | 守护灵 |
| 金币获得 | GOLD_PER_CARD | 每张牌额外获得X金币 | 守护灵 |
| 分数翻倍 | DOUBLE_SCORE | 本回合分数翻倍 | 法术 |

### 效果触发流程

```
1. 事件发生 (如：打出卡牌)
    ↓
2. 检查触发时机匹配的能力
    ↓
3. 按优先级执行效果
    ↓
4. 更新游戏状态
    ↓
5. 刷新UI显示
```

---

## 🎮 游戏集成

### GameManager集成

<augment_code_snippet path="cs/Global/GameManager.gd" mode="EXCERPT">
````gdscript
# ===== 玩家资源（符合v1.6规范）=====
var equipped_artifacts: Array[ArtifactData] = []  # 装备的法器
var spell_inventory: Array[SpellData] = []        # 持有的法术
var active_jokers: Array[JokerData] = []          # 激活的守护灵

# 添加法术
func add_spell(spell: SpellData):
    # 检查是否已有同名法术，如果有则增加充能
    for existing_spell in spell_inventory:
        if existing_spell.id == spell.id:
            existing_spell.charges += spell.charges
            return
    
    # 如果没有同名法术，则添加新法术
    spell_inventory.append(spell)

# 激活守护灵
func activate_joker(joker: JokerData, old_joker_index: int = -1):
    if old_joker_index >= 0 and old_joker_index < active_jokers.size():
        # 替换现有守护灵
        active_jokers[old_joker_index] = joker
    else:
        # 添加新守护灵
        active_jokers.append(joker)
````
</augment_code_snippet>

### 稀有度系统

<augment_code_snippet path="cs/Global/GlobalEnums.gd" mode="EXCERPT">
````gdscript
# 稀有度枚举
enum Rarity {
    COMMON,      # 普通 - 白色
    RARE,        # 稀有 - 蓝色
    EPIC,        # 史诗 - 紫色
    LEGENDARY    # 传说 - 橙色
}
````
</augment_code_snippet>

---

## 📊 数据配置

### 目录结构

```
assets/data/
├── artifacts/          # 法器配置文件
│   └── apprentice_notes.tres
├── spells/            # 法术配置文件
│   └── flash_of_insight.tres
├── jokers/            # 守护灵配置文件
│   └── pair_master.tres
└── game_config.tres   # 全局配置
```

### 配置示例

每个能力都通过独立的`.tres`文件进行配置，支持：
- 基础属性（ID、名称、描述、稀有度、价格）
- 效果属性（效果类型、效果数值）
- 特殊属性（触发时机、充能数量等）

---

## 🔧 扩展指南

### 添加新守护灵

1. 创建新的`.tres`文件在`assets/data/jokers/`
2. 配置基础属性和效果
3. 在效果系统中实现对应的效果逻辑
4. 测试触发时机和效果数值

### 添加新法术

1. 创建新的`.tres`文件在`assets/data/spells/`
2. 选择法术类型（瞬发/技能区）
3. 配置充能机制（如适用）
4. 实现法术效果逻辑

### 添加新法器

1. 创建新的`.tres`文件在`assets/data/artifacts/`
2. 配置被动效果
3. 确保效果与游戏机制兼容
4. 平衡测试效果强度

---

## 🛠️ 视图组件

### 守护灵视图 - JokerView

守护灵的UI组件负责显示守护灵信息和处理交互：

```gdscript
# JokerView.gd - 守护灵视图组件
class_name JokerView
extends Control

signal joker_clicked(joker_data)

var joker_data: JokerData
var joker_image: TextureRect
var joker_name_label: Label
var joker_description_label: Label

func setup(data: JokerData):
    joker_data = data
    update_display()

func update_display():
    if joker_data:
        joker_name_label.text = joker_data.name
        joker_description_label.text = joker_data.get_description()
        # 根据稀有度设置边框颜色
        set_rarity_border(joker_data.rarity)
```

### 法术视图 - SpellView

法术的UI组件支持充能显示和使用交互：

```gdscript
# SpellView.gd - 法术视图组件
class_name SpellView
extends Control

signal spell_used(spell_data)

var spell_data: SpellData
var charges_label: Label
var use_button: Button

func setup(data: SpellData):
    spell_data = data
    update_display()

    # 连接使用按钮
    use_button.pressed.connect(_on_use_pressed)

func update_display():
    if spell_data:
        charges_label.text = str(spell_data.charges)
        use_button.disabled = spell_data.charges <= 0

func _on_use_pressed():
    if spell_data.use():
        spell_used.emit(spell_data)
        update_display()
```

### 法器视图 - ArtifactItem

法器的UI组件显示法器信息和效果：

```gdscript
# ArtifactItem.gd - 法器视图组件
class_name ArtifactItem
extends BaseItemView

var artifact_data: ArtifactData

func setup_item(data: ArtifactData):
    artifact_data = data
    item_name_label.text = data.name
    item_description_label.text = data.get_description()

    # 设置稀有度样式
    apply_rarity_style(data.rarity)
```

---

## 🎨 UI集成

### 容器布局

游戏主界面中各系统的UI布局：

```
MainGame Scene
├── UIContainer
│   ├── TopDock
│   │   ├── MagicDiscoveryPanel (魔法发现)
│   │   └── ArtifactPanel (传奇法器)
│   ├── BottomDock
│   │   ├── HandContainer (手牌区)
│   │   └── JokerContainer (守护灵区)
│   └── SidePanel
│       └── SpellContainer (法术技能区)
```

### 交互流程

1. **守护灵交互**：
   - 点击守护灵查看详细信息
   - 拖拽替换守护灵位置
   - 右键菜单进行管理操作

2. **法术交互**：
   - 点击法术图标使用法术
   - 充能数量实时显示
   - 冷却状态视觉反馈

3. **法器交互**：
   - 鼠标悬停显示详细效果
   - 法器效果在游戏中持续生效
   - 法器数量限制提示

---

## 📈 性能优化

### 对象池管理

为了优化性能，系统使用对象池管理视图组件：

```gdscript
# ViewPool.gd - 视图对象池
class_name ViewPool
extends Node

var joker_view_pool: Array[JokerView] = []
var spell_view_pool: Array[SpellView] = []
var artifact_view_pool: Array[ArtifactItem] = []

func get_joker_view() -> JokerView:
    if joker_view_pool.size() > 0:
        return joker_view_pool.pop_back()
    else:
        return joker_view_scene.instantiate()

func return_joker_view(view: JokerView):
    view.reset()
    joker_view_pool.append(view)
```

### 事件系统优化

使用信号系统减少耦合，提高性能：

```gdscript
# 全局事件总线
signal ability_triggered(ability_type, ability_data, effect_result)
signal ui_update_required(system_type)
signal resource_changed(resource_type, old_value, new_value)
```

---

## 🧪 测试框架

### 单元测试

每个系统都有对应的测试用例：

```gdscript
# test_joker_system.gd
extends GutTest

func test_joker_trigger_timing():
    var joker = JokerData.new()
    joker.trigger_timing = GlobalEnums.EffectTriggerTiming.ON_SCORE_CALCULATION

    # 测试触发时机匹配
    assert_true(joker.should_trigger_on(GlobalEnums.EffectTriggerTiming.ON_SCORE_CALCULATION))
    assert_false(joker.should_trigger_on(GlobalEnums.EffectTriggerTiming.ON_TURN_START))

func test_spell_charge_system():
    var spell = SpellData.new()
    spell.charges = 3

    # 测试充能消耗
    assert_true(spell.use())
    assert_eq(spell.charges, 2)

    # 测试充能增加
    spell.add_charge(2)
    assert_eq(spell.charges, 4)
```

### 集成测试

测试系统间的协作：

```gdscript
# test_ability_integration.gd
extends GutTest

func test_joker_effect_on_score():
    var joker = create_test_joker("SCORE_BONUS", 0.2)
    GameManager.activate_joker(joker)

    var base_score = 100
    var final_score = calculate_score_with_abilities(base_score)

    assert_eq(final_score, 120)  # 100 * 1.2
```

---

## 📚 API参考

### JokerData API

```gdscript
# 主要方法
func get_description() -> String          # 获取描述文本
func should_trigger_on(timing: int) -> bool  # 检查是否应在指定时机触发
func clone() -> JokerData                # 克隆守护灵数据
```

### SpellData API

```gdscript
# 主要方法
func get_info() -> String                # 获取法术信息
func use() -> bool                       # 使用法术（消耗充能）
func add_charge(amount: int = 1) -> void # 增加充能
func can_use() -> bool                   # 检查是否可以使用
```

### ArtifactData API

```gdscript
# 主要方法
func get_description() -> String         # 获取描述文本
func get_info() -> String               # 获取法器信息
func clone() -> ArtifactData            # 克隆法器数据
func is_stackable() -> bool             # 检查是否可叠加
```

---

## 🔮 未来扩展

### 计划功能

1. **组合效果系统**：
   - 多个守护灵的协同效果
   - 法器套装效果
   - 法术连击系统

2. **动态效果**：
   - 基于游戏状态的动态效果调整
   - 条件触发的复杂效果
   - 时间限制的临时效果

3. **自定义能力**：
   - 玩家自定义守护灵
   - 模组支持系统
   - 社区内容分享

### 技术改进

1. **性能优化**：
   - 更高效的效果计算
   - 批量UI更新
   - 内存使用优化

2. **可维护性**：
   - 更好的代码文档
   - 自动化测试覆盖
   - 配置验证工具

---

## 🎯 总结

守护灵、法术与法器系统为奥术学院扑克提供了丰富的策略深度和可玩性。通过数据驱动的设计，系统具有高度的可配置性和扩展性，能够轻松添加新的能力和效果，为玩家提供持续的新鲜体验。

### 核心优势

- **模块化设计**：各系统独立但协调工作
- **数据驱动**：配置与代码分离，便于调整
- **扩展性强**：新增能力无需修改核心代码
- **性能优化**：对象池和事件系统确保流畅体验
- **测试完备**：完整的测试框架保证质量

这套系统为游戏提供了坚实的基础，支持未来的功能扩展和内容更新。
