---
描述: 阶段三：高级卡牌操作与完整分数&效果系统
---

# 阶段三：高级卡牌操作与完整效果体系

> 前置：阶段二已完成核心流程（学年/学期循环）、ScoreCalculator 扩展、GameManager 精简及基础 UI 流转。
> 目标：在此基础上，完善牌库管理、强化&效果链、商店/随机事件，并打磨整体可玩性。

---

## 1. CardManager 深度实现（牌库/弃牌堆/手牌/销毁堆）
### 1.1 字段扩充
- `deck:Array[CardData]`
- `discard_pile:Array[CardData]`
- `hand:Array[CardData]`
- `destroyed_pile:Array[CardData]`
- `max_hand_size:int`（随 Artifact/Spell 动态变化）

### 1.2 方法
| 方法 | 说明 |
|------|------|
| `initialize_deck(cards:Array)` | 新学年/开局重置牌库 |
| `draw(count:int)` | 抽牌，若不足则洗牌重抽 |
| `discard(index:int)` | 弃牌到 `discard_pile` |
| `play_card(index:int)` | 从手牌打出卡牌，返回 `CardData` |
| `add_reinforcement_to_card_in_hand(card_id:String, type:String, effect:String)` | 手牌强化 |
| `remove_card_from_deck(card_id:String)` | 永久移除 |
| `add_card_to_deck(card_data:CardData)` | 永久加入 |

### 1.3 信号
- `hand_changed(hand:Array)`
- `deck_changed(deck_size:int)`
- `card_played(card_data)`
- `card_destroyed(card_data)`

### 1.4 验收
- 单元测试覆盖抽牌/洗牌/弃牌/打牌/销毁等操作。

---

## 2. EventManager 完整 Buff / Debuff & 随机事件系统
### 2.1 Buff / Debuff 数据结构
```gdscript
class Buff:
    var id:String
    var description:String
    var duration:int # 回合数或学期数
    var modifiers:Dictionary # 任意效果键值
```
### 2.2 主要方法
- `add_term_buff(buff:Buff)`
- `add_turn_buff(buff:Buff)`
- `apply_buffs(target:String, params)`
- `trigger_random_event()`  读取 `assets/data/events/` 资源
- `tick_buffs()`  每回合 / 学期递减持续时间

### 2.3 信号
- `buff_applied(buff)`
- `buff_expired(buff)`
- `random_event_triggered(event_id, description)`

### 2.4 验收
- 随机事件出现概率、Buff 叠加与过期逻辑正确。

---

## 3. Artefact / Spell / Joker 效果调度
### 3.1 数据脚本
- `ArtifactData.gd`, `SpellData.gd`, `JokerData.gd` 均已继承 Resource，需补充 `effect_type` 与 `effect_value` 字段。

### 3.2 GameManager.trigger_effect_logic()
- 使用 `match effect_type` 分派到对应逻辑（示例：`ADD_LORE`, `MODIFY_HAND_SIZE`, `ADD_CARD_REINFORCEMENT`）。
- 支持嵌套 / 链式效果（例如触发蜡封后再次调用自身）。

### 3.3 流派测试
- 为每种稀有度准备 3–5 个 Artefact/Spell/Joker，提升商店概率进行集中测试。

---

## 4. 商店（Wisdom Hall）系统
### 4.1 WisdomHallManager.gd
- 读取 `GameConfig.shop_rarity_probabilities` 与 `shop_cost_ranges`。
- `refresh_shop_offers()` 随稀有度生成 Artefact/Spell/Joker 供购买。
- `purchase(item_id)` 校验资源 & 扣费后发信号。

### 4.2 UI
- `WisdomHallPanel` 显示 4–6 个可购买项目，点击购买触发 `purchase()`。

### 4.3 验收
- 购买逻辑正确，物品加入玩家能力列表；库存随回合刷新。

---

## 5. 分数与牌型等级长期成长
- GameManager 增加 `modify_card_type_level(type_name, amount)`，每学期结算经验提升。
- 在 Assessment 阶段根据成绩奖励经验与能力。

---

## 6. UI 打磨
- 新增 “Buff/Debuff 图标栏”
- Artefact/Spell/Joker 面板
- 牌型等级进度条

---

## 7. 测试 & 调优
1. **自动化测试**：`test/` 目录下添加 CardManager、EventManager、Effect 调度的 GUT 单元测试。
2. **性能评测**：60Hz 目标帧率，检查对象池重用率。
3. **平衡性测试**：多人试玩收集数据，调整 `GameConfig`。

---

## 推荐实施顺序
1. CardManager 深度实现 (基础操作)  
2. EventManager Buff/Debuff & 随机事件  
3. Artefact/Spell/Joker 效果调度  
4. 商店系统  
5. 分数&等级成长  
6. UI 打磨  
7. 全面测试与优化

---

## 里程碑示例
| 周次 | 目标 | 可交付物 |
|------|------|---------|
| W1 | CardManager + 单测 | 手牌/抽牌流程稳定运行 |
| W2 | EventManager + Buff 逻辑 | 随机事件可触发并生效 |
| W3 | 效果调度 + 10 个 Artefact/Spell | 流派测试 Demo |
| W4 | 商店系统 + UI 初版 | WisdomHall 可购买物品 |
| W5 | 牌型等级成长 + Assessment 奖励 | 年度循环打通 |
| W6 | UI 打磨 + 压力测试 | Beta 版本发布 |

---

完成阶段三后，核心玩法与成长系统基本成型，可进入 **阶段四：内容扩充与可视化优化**（更多卡牌、美术、音效、网络排行榜等）。
